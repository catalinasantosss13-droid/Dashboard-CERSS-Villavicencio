<!DOCTYPE html>
<html lang="es">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Dashboard BI - CERS 2025 Villavicencio</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <script src="https://cdn.jsdelivr.net/npm/chart.js@4.4.0/dist/chart.umd.min.js"></script>
    <script src="https://cdn.jsdelivr.net/npm/papaparse@5.4.1/papaparse.min.js"></script>
    <style>
        .tab-content { display: none; }
        .tab-content.active { display: block; }
        .tab-button.active { 
            background-color: #3b82f6; 
            color: white; 
        }
        .kpi-card {
            background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
            color: white;
            padding: 1.5rem;
            border-radius: 0.5rem;
            box-shadow: 0 4px 6px rgba(0, 0, 0, 0.1);
        }
        .chart-container {
            position: relative;
            height: 400px;
            margin-bottom: 2rem;
        }
        table {
            border-collapse: collapse;
            width: 100%;
            background: white;
            box-shadow: 0 1px 3px rgba(0, 0, 0, 0.1);
        }
        th {
            background-color: #1f2937;
            color: white;
            padding: 1rem;
            text-align: left;
            font-weight: 600;
            position: sticky;
            top: 0;
            z-index: 10;
        }
        td {
            padding: 0.75rem 1rem;
            border-bottom: 1px solid #e5e7eb;
        }
        tr:hover {
            background-color: #f9fafb;
        }
        .search-input {
            width: 100%;
            padding: 0.75rem;
            border: 2px solid #e5e7eb;
            border-radius: 0.5rem;
            margin-bottom: 1rem;
            font-size: 1rem;
        }
        .search-input:focus {
            outline: none;
            border-color: #3b82f6;
        }
        .loading {
            display: flex;
            justify-content: center;
            align-items: center;
            min-height: 300px;
        }
        .spinner {
            border: 4px solid #f3f4f6;
            border-top: 4px solid #3b82f6;
            border-radius: 50%;
            width: 50px;
            height: 50px;
            animation: spin 1s linear infinite;
        }
        @keyframes spin {
            0% { transform: rotate(0deg); }
            100% { transform: rotate(360deg); }
        }
    </style>
</head>
<body class="bg-gray-50">
    <div class="container mx-auto px-4 py-8 max-w-7xl">
        <header class="mb-8 bg-white rounded-lg shadow-md p-6">
            <div class="flex flex-col md:flex-row items-center justify-between gap-4">
                <div class="flex items-center gap-4">
                    <img src="logos/unillanos.png" alt="Universidad de los Llanos" class="h-16 md:h-20">
                    <img src="logos/alcaldia.png" alt="Alcald√≠a de Villavicencio" class="h-16 md:h-20">
                </div>
                <div class="text-center md:text-right">
                    <h1 class="text-3xl md:text-4xl font-bold text-gray-800 mb-2">Dashboard Anal√≠tico BI</h1>
                    <p class="text-gray-600 text-lg">Matriz Comparativa CERS 2025 - Villavicencio</p>
                </div>
            </div>
        </header>

        <div class="mb-6 flex flex-wrap gap-2 border-b-2 border-gray-200">
            <button onclick="switchTab('nacional')" class="tab-button active px-6 py-3 font-semibold rounded-t-lg transition-all" id="tab-nacional">
                üìä Nacional
            </button>
            <button onclick="switchTab('internacional')" class="tab-button px-6 py-3 font-semibold rounded-t-lg transition-all" id="tab-internacional">
                üåé Internacional
            </button>
            <button onclick="switchTab('general')" class="tab-button px-6 py-3 font-semibold rounded-t-lg transition-all" id="tab-general">
                üìà General
            </button>
        </div>

        <div id="content-nacional" class="tab-content active">
            <div class="loading" id="loading-nacional">
                <div class="spinner"></div>
            </div>
            <div id="data-nacional" style="display: none;">
                <div class="grid grid-cols-1 md:grid-cols-4 gap-4 mb-8" id="kpis-nacional"></div>
                <div class="grid grid-cols-1 lg:grid-cols-2 gap-6 mb-8">
                    <div class="bg-white p-6 rounded-lg shadow">
                        <h3 class="text-xl font-semibold mb-4 text-gray-800">Distribuci√≥n por Categor√≠a</h3>
                        <div class="chart-container">
                            <canvas id="chart-nacional-1"></canvas>
                        </div>
                    </div>
                    <div class="bg-white p-6 rounded-lg shadow">
                        <h3 class="text-xl font-semibold mb-4 text-gray-800">Tendencias y Comparativas</h3>
                        <div class="chart-container">
                            <canvas id="chart-nacional-2"></canvas>
                        </div>
                    </div>
                </div>
                <div class="bg-white p-6 rounded-lg shadow">
                    <h3 class="text-xl font-semibold mb-4 text-gray-800">Datos Detallados</h3>
                    <input type="text" id="search-nacional" class="search-input" placeholder="üîç Buscar en los datos...">
                    <div class="overflow-x-auto">
                        <table id="table-nacional"></table>
                    </div>
                </div>
            </div>
        </div>

        <div id="content-internacional" class="tab-content">
            <div class="loading" id="loading-internacional">
                <div class="spinner"></div>
            </div>
            <div id="data-internacional" style="display: none;">
                <div class="grid grid-cols-1 md:grid-cols-4 gap-4 mb-8" id="kpis-internacional"></div>
                <div class="grid grid-cols-1 lg:grid-cols-2 gap-6 mb-8">
                    <div class="bg-white p-6 rounded-lg shadow">
                        <h3 class="text-xl font-semibold mb-4 text-gray-800">Distribuci√≥n por Categor√≠a</h3>
                        <div class="chart-container">
                            <canvas id="chart-internacional-1"></canvas>
                        </div>
                    </div>
                    <div class="bg-white p-6 rounded-lg shadow">
                        <h3 class="text-xl font-semibold mb-4 text-gray-800">Tendencias y Comparativas</h3>
                        <div class="chart-container">
                            <canvas id="chart-internacional-2"></canvas>
                        </div>
                    </div>
                </div>
                <div class="bg-white p-6 rounded-lg shadow">
                    <h3 class="text-xl font-semibold mb-4 text-gray-800">Datos Detallados</h3>
                    <input type="text" id="search-internacional" class="search-input" placeholder="üîç Buscar en los datos...">
                    <div class="overflow-x-auto">
                        <table id="table-internacional"></table>
                    </div>
                </div>
            </div>
        </div>

        <div id="content-general" class="tab-content">
            <div class="loading" id="loading-general">
                <div class="spinner"></div>
            </div>
            <div id="data-general" style="display: none;">
                <div class="grid grid-cols-1 md:grid-cols-4 gap-4 mb-8" id="kpis-general"></div>
                <div class="grid grid-cols-1 lg:grid-cols-2 gap-6 mb-8">
                    <div class="bg-white p-6 rounded-lg shadow">
                        <h3 class="text-xl font-semibold mb-4 text-gray-800">Distribuci√≥n por Categor√≠a</h3>
                        <div class="chart-container">
                            <canvas id="chart-general-1"></canvas>
                        </div>
                    </div>
                    <div class="bg-white p-6 rounded-lg shadow">
                        <h3 class="text-xl font-semibold mb-4 text-gray-800">Tendencias y Comparativas</h3>
                        <div class="chart-container">
                            <canvas id="chart-general-2"></canvas>
                        </div>
                    </div>
                </div>
                <div class="bg-white p-6 rounded-lg shadow">
                    <h3 class="text-xl font-semibold mb-4 text-gray-800">Datos Detallados</h3>
                    <input type="text" id="search-general" class="search-input" placeholder="üîç Buscar en los datos...">
                    <div class="overflow-x-auto">
                        <table id="table-general"></table>
                    </div>
                </div>
            </div>
        </div>
    </div>

    <footer class="bg-gray-800 text-white py-6 mt-12">
        <div class="container mx-auto px-4 text-center">
            <p class="text-sm md:text-base">
                Elaborado por <span class="font-semibold">Catalina Santos</span> - Estudiante de enfermer√≠a IX Semestre
            </p>
        </div>
    </footer>

    <script>
        const DATA_SOURCES = {
            nacional: 'https://docs.google.com/spreadsheets/d/e/2PACX-1vR3D2ho2jJV0hYbNOzVweclC4SYDifw5AGMEV8HO318cgxpl9tz4nkocubdFCrxxOX7Z8DZ21Ex-1IG/pub?gid=563980265&single=true&output=csv',
            internacional: 'https://docs.google.com/spreadsheets/d/e/2PACX-1vR3D2ho2jJV0hYbNOzVweclC4SYDifw5AGMEV8HO318cgxpl9tz4nkocubdFCrxxOX7Z8DZ21Ex-1IG/pub?gid=804794750&single=true&output=csv',
            general: 'https://docs.google.com/spreadsheets/d/e/2PACX-1vR3D2ho2jJV0hYbNOzVweclC4SYDifw5AGMEV8HO318cgxpl9tz4nkocubdFCrxxOX7Z8DZ21Ex-1IG/pub?gid=24842196&single=true&output=csv'
        };

        let dataCache = {};
        let chartsCache = {};

        function switchTab(tabName) {
            document.querySelectorAll('.tab-content').forEach(el => el.classList.remove('active'));
            document.querySelectorAll('.tab-button').forEach(el => el.classList.remove('active'));
            
            document.getElementById(`content-${tabName}`).classList.add('active');
            document.getElementById(`tab-${tabName}`).classList.add('active');

            if (!dataCache[tabName]) {
                loadData(tabName);
            }
        }

        function loadData(source) {
            Papa.parse(DATA_SOURCES[source], {
                download: true,
                header: true,
                complete: function(results) {
                    dataCache[source] = results.data.filter(row => {
                        return Object.values(row).some(val => val && val.toString().trim() !== '');
                    });
                    renderDashboard(source, dataCache[source]);
                },
                error: function(error) {
                    console.error('Error loading data:', error);
                    document.getElementById(`loading-${source}`).innerHTML = 
                        '<div class="text-red-600 text-center"><p class="text-xl">‚ùå Error al cargar los datos</p><p class="mt-2">Por favor, verifica la conexi√≥n a internet</p></div>';
                }
            });
        }

        function renderDashboard(source, data) {
            document.getElementById(`loading-${source}`).style.display = 'none';
            document.getElementById(`data-${source}`).style.display = 'block';

            renderKPIs(source, data);
            renderCharts(source, data);
            renderTable(source, data);
            setupSearch(source, data);
        }

        function renderKPIs(source, data) {
            const kpisContainer = document.getElementById(`kpis-${source}`);
            const columns = Object.keys(data[0] || {});
            
            const kpis = [
                { label: 'Total de Registros', value: data.length, icon: 'üìä' },
                { label: 'Columnas de Datos', value: columns.length, icon: 'üìã' },
                { label: 'Campos Completos', value: calculateCompleteness(data), icon: '‚úÖ' },
                { label: '√öltima Actualizaci√≥n', value: new Date().toLocaleDateString('es-ES'), icon: 'üìÖ' }
            ];

            kpisContainer.innerHTML = kpis.map(kpi => `
                <div class="kpi-card">
                    <div class="text-3xl mb-2">${kpi.icon}</div>
                    <div class="text-3xl font-bold mb-1">${kpi.value}</div>
                    <div class="text-sm opacity-90">${kpi.label}</div>
                </div>
            `).join('');
        }

        function calculateCompleteness(data) {
            if (data.length === 0) return '0%';
            const totalCells = data.length * Object.keys(data[0]).length;
            const filledCells = data.reduce((sum, row) => {
                return sum + Object.values(row).filter(val => val && val.toString().trim() !== '').length;
            }, 0);
            return Math.round((filledCells / totalCells) * 100) + '%';
        }

        function renderCharts(source, data) {
            if (chartsCache[source]) {
                chartsCache[source].forEach(chart => chart.destroy());
            }
            chartsCache[source] = [];

            const columns = Object.keys(data[0] || {});
            const numericColumns = columns.filter(col => {
                return data.some(row => !isNaN(parseFloat(row[col])));
            });

            const categoricalColumns = columns.filter(col => !numericColumns.includes(col));

            if (categoricalColumns.length > 0) {
                const firstCatColumn = categoricalColumns[0];
                const distribution = {};
                data.forEach(row => {
                    const value = row[firstCatColumn] || 'Sin categor√≠a';
                    distribution[value] = (distribution[value] || 0) + 1;
                });

                const labels = Object.keys(distribution).slice(0, 10);
                const values = labels.map(label => distribution[label]);

                const ctx1 = document.getElementById(`chart-${source}-1`).getContext('2d');
                const chart1 = new Chart(ctx1, {
                    type: 'bar',
                    data: {
                        labels: labels,
                        datasets: [{
                            label: firstCatColumn,
                            data: values,
                            backgroundColor: 'rgba(59, 130, 246, 0.7)',
                            borderColor: 'rgba(59, 130, 246, 1)',
                            borderWidth: 2
                        }]
                    },
                    options: {
                        responsive: true,
                        maintainAspectRatio: false,
                        plugins: {
                            legend: { display: true, position: 'top' }
                        },
                        scales: {
                            y: { beginAtZero: true }
                        }
                    }
                });
                chartsCache[source].push(chart1);
            }

            if (numericColumns.length > 0) {
                const numCol = numericColumns[0];
                const chartData = data.slice(0, 20).map((row, idx) => ({
                    x: idx + 1,
                    y: parseFloat(row[numCol]) || 0
                }));

                const ctx2 = document.getElementById(`chart-${source}-2`).getContext('2d');
                const chart2 = new Chart(ctx2, {
                    type: 'line',
                    data: {
                        datasets: [{
                            label: numCol,
                            data: chartData,
                            borderColor: 'rgba(168, 85, 247, 1)',
                            backgroundColor: 'rgba(168, 85, 247, 0.1)',
                            borderWidth: 3,
                            fill: true,
                            tension: 0.4
                        }]
                    },
                    options: {
                        responsive: true,
                        maintainAspectRatio: false,
                        plugins: {
                            legend: { display: true, position: 'top' }
                        },
                        scales: {
                            x: { type: 'linear', title: { display: true, text: 'Registro' } },
                            y: { beginAtZero: true, title: { display: true, text: numCol } }
                        }
                    }
                });
                chartsCache[source].push(chart2);
            } else {
                if (categoricalColumns.length > 1) {
                    const secondCatColumn = categoricalColumns[1];
                    const distribution = {};
                    data.forEach(row => {
                        const value = row[secondCatColumn] || 'Sin categor√≠a';
                        distribution[value] = (distribution[value] || 0) + 1;
                    });

                    const labels = Object.keys(distribution).slice(0, 8);
                    const values = labels.map(label => distribution[label]);

                    const ctx2 = document.getElementById(`chart-${source}-2`).getContext('2d');
                    const chart2 = new Chart(ctx2, {
                        type: 'doughnut',
                        data: {
                            labels: labels,
                            datasets: [{
                                data: values,
                                backgroundColor: [
                                    'rgba(239, 68, 68, 0.7)',
                                    'rgba(59, 130, 246, 0.7)',
                                    'rgba(34, 197, 94, 0.7)',
                                    'rgba(168, 85, 247, 0.7)',
                                    'rgba(251, 191, 36, 0.7)',
                                    'rgba(236, 72, 153, 0.7)',
                                    'rgba(20, 184, 166, 0.7)',
                                    'rgba(249, 115, 22, 0.7)'
                                ]
                            }]
                        },
                        options: {
                            responsive: true,
                            maintainAspectRatio: false,
                            plugins: {
                                legend: { display: true, position: 'right' }
                            }
                        }
                    });
                    chartsCache[source].push(chart2);
                }
            }
        }

        function renderTable(source, data) {
            const table = document.getElementById(`table-${source}`);
            if (data.length === 0) {
                table.innerHTML = '<p class="text-center text-gray-500 p-4">No hay datos disponibles</p>';
                return;
            }

            const columns = Object.keys(data[0]);
            
            let html = '<thead><tr>';
            columns.forEach(col => {
                html += `<th class="cursor-pointer" onclick="sortTable('${source}', '${col}')">${col} ‚ÜïÔ∏è</th>`;
            });
            html += '</tr></thead><tbody id="tbody-${source}">';
            
            data.forEach(row => {
                html += '<tr>';
                columns.forEach(col => {
                    html += `<td>${row[col] || ''}</td>`;
                });
                html += '</tr>';
            });
            
            html += '</tbody>';
            table.innerHTML = html;
        }

        function setupSearch(source, data) {
            const searchInput = document.getElementById(`search-${source}`);
            searchInput.addEventListener('input', function(e) {
                const searchTerm = e.target.value.toLowerCase();
                const filteredData = data.filter(row => {
                    return Object.values(row).some(val => 
                        val && val.toString().toLowerCase().includes(searchTerm)
                    );
                });
                renderTable(source, filteredData);
            });
        }

        function sortTable(source, column) {
            const data = dataCache[source];
            const isNumeric = !isNaN(parseFloat(data[0][column]));
            
            data.sort((a, b) => {
                const aVal = a[column];
                const bVal = b[column];
                
                if (isNumeric) {
                    return parseFloat(aVal || 0) - parseFloat(bVal || 0);
                } else {
                    return (aVal || '').toString().localeCompare((bVal || '').toString());
                }
            });
            
            renderTable(source, data);
        }

        loadData('nacional');
    </script>
</body>
</html>
