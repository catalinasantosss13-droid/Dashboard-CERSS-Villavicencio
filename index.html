<!DOCTYPE html>
<html lang="es">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Dashboard análisis Plan de Acción de la Política Pública de MCYEVS Villavicencio</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <script src="https://cdn.jsdelivr.net/npm/chart.js@4.4.0/dist/chart.umd.min.js"></script>
    <script src="https://cdn.jsdelivr.net/npm/papaparse@5.4.1/papaparse.min.js"></script>
    
    <style>
        /* Estilos Base y Transiciones */
        body {
            font-family: ui-sans-serif, system-ui, -apple-system, BlinkMacSystemFont, "Segoe UI", Roboto, "Helvetica Neue", Arial, "Noto Sans", sans-serif;
            background-color: #f7f7f7; /* Gris muy claro para el fondo */
        }
        .tab-content { display: none; }
        .tab-content.active { display: block; }
        .tab-button {
            color: #4b5563;
            transition: all 0.2s ease;
            border-bottom: 3px solid transparent;
        }
        .tab-button:hover {
            color: #1d4ed8;
        }
        .tab-button.active { 
            color: #1d4ed8; /* Azul más oscuro para activo */
            background-color: transparent;
            border-bottom: 3px solid #1d4ed8;
            font-weight: 700;
        }
        
        /* Estilos de las tarjetas KPI mejoradas */
        .kpi-card-improved {
            background-color: white;
            padding: 1.5rem;
            border-radius: 0.75rem; /* Bordes más suaves */
            box-shadow: 0 10px 15px -3px rgba(0, 0, 0, 0.05), 0 4px 6px -2px rgba(0, 0, 0, 0.05); /* Sombra más definida */
            transition: transform 0.2s ease;
        }
        .kpi-card-improved:hover {
            transform: translateY(-3px);
        }
        .kpi-value {
            font-size: 2.25rem;
            font-weight: 800;
            line-height: 1;
        }
        .kpi-label {
            font-size: 0.875rem;
            text-transform: uppercase;
            letter-spacing: 0.05em;
            color: #6b7280;
        }

        /* Estilos de Gráficos y Tablas */
        .chart-container {
            position: relative;
            height: 400px;
            margin-bottom: 2rem;
        }
        .data-card {
            background-color: white;
            padding: 1.5rem;
            border-radius: 0.75rem;
            box-shadow: 0 4px 6px -1px rgba(0, 0, 0, 0.1), 0 2px 4px -2px rgba(0, 0, 0, 0.1);
        }
        table {
            border-collapse: collapse;
            width: 100%;
            background: white;
            box-shadow: none;
        }
        th {
            background-color: #4b5563; /* Gris oscuro para header de tabla */
            color: white;
            padding: 1rem;
            text-align: left;
            font-weight: 600;
            position: sticky;
            top: 0;
            z-index: 10;
        }
        /* Mantiene estilos de carga */
        .loading { display: flex; justify-content: center; align-items: center; min-height: 300px; }
        .spinner { border: 4px solid #e5e7eb; border-top: 4px solid #1d4ed8; border-radius: 50%; width: 50px; height: 50px; animation: spin 1s linear infinite; }
        @keyframes spin { 0% { transform: rotate(0deg); } 100% { transform: rotate(360deg); } }
    </style>
</head>
<body class="bg-gray-100">
    <div class="container mx-auto px-4 py-8 max-w-7xl">
        <header class="mb-8 p-6 rounded-xl shadow-xl" style="background: linear-gradient(135deg, #1d4ed8 0%, #3b82f6 100%); color: white;">
            <div class="flex flex-col md:flex-row items-center justify-between gap-4">
                <div class="flex items-center gap-4">
                    <img src="logos/unillanos.png" alt="Universidad de los Llanos" class="h-16 md:h-20 bg-white p-1 rounded-lg">
                    <img src="logos/alcaldia.png" alt="Alcaldía de Villavicencio" class="h-16 md:h-20 bg-white p-1 rounded-lg">
                </div>
                <div class="text-center md:text-right">
                    <h1 class="text-3xl md:text-4xl font-extrabold mb-2">Dashboard Analítico Plan de Acción Política Pública MCYEVS Villavicencio</h1>
                    <p class="text-gray-200 text-lg">Matriz comparativa Plan de Acción Política Pública MCYEVS - Villavicencio</p>
                </div>
            </div>
        </header>

        <div class="mb-6 flex flex-wrap gap-4 border-b-2 border-gray-300 bg-white p-3 rounded-lg shadow-md">
            <button onclick="switchTab('nacional')" class="tab-button active px-4 py-2 text-base rounded-md" id="tab-nacional">
                Nacional
            </button>
            <button onclick="switchTab('internacional')" class="tab-button px-4 py-2 text-base rounded-md" id="tab-internacional">
                Internacional
            </button>
            <button onclick="switchTab('general')" class="tab-button px-4 py-2 text-base rounded-md" id="tab-general">
                General
            </button>
        </div>

        <div id="content-nacional" class="tab-content active">
            <div class="loading" id="loading-nacional">
                <div class="spinner"></div>
            </div>
            <div id="data-nacional" style="display: none;">
                <div class="grid grid-cols-1 md:grid-cols-4 gap-6 mb-8" id="kpis-nacional"></div>
                
                <div class="grid grid-cols-1 lg:grid-cols-2 gap-6 mb-8">
                    <div class="data-card">
                        <h3 class="text-xl font-semibold mb-4 text-gray-800">Distribución de niveles de alineamiento</h3>
                        <div class="chart-container">
                            <canvas id="chart-nacional-1"></canvas>
                        </div>
                    </div>
                    <div class="data-card">
                        <h3 class="text-xl font-semibold mb-4 text-gray-800">Promedio de alineamiento</h3>
                        <div class="chart-container">
                            <canvas id="chart-nacional-2"></canvas>
                        </div>
                        <div id="stats-nacional" class="mt-4 text-center"></div>
                    </div>
                </div>

                <div class="data-card">
                    <h3 class="text-xl font-semibold mb-4 text-gray-800">Resumen de líneas</h3>
                    <input type="text" id="search-nacional" class="search-input" placeholder="Buscar en la tabla...">
                    <div class="overflow-x-auto" style="max-height: 400px; overflow-y: auto;">
                        <table id="table-nacional"></table>
                    </div>
                </div>
            </div>
        </div>

        <div id="content-internacional" class="tab-content">
            <div class="loading" id="loading-internacional">
                <div class="spinner"></div>
            </div>
            <div id="data-internacional" style="display: none;">
                <div class="grid grid-cols-1 md:grid-cols-4 gap-6 mb-8" id="kpis-internacional"></div>
                <div class="grid grid-cols-1 lg:grid-cols-2 gap-6 mb-8">
                    <div class="data-card">
                        <h3 class="text-xl font-semibold mb-4 text-gray-800">Distribución de niveles de alineamiento</h3>
                        <div class="chart-container">
                            <canvas id="chart-internacional-1"></canvas>
                        </div>
                    </div>
                    <div class="data-card">
                        <h3 class="text-xl font-semibold mb-4 text-gray-800">Promedio de alineamiento</h3>
                        <div class="chart-container">
                            <canvas id="chart-internacional-2"></canvas>
                        </div>
                        <div id="stats-internacional" class="mt-4 text-center"></div>
                    </div>
                </div>
                <div class="data-card">
                    <h3 class="text-xl font-semibold mb-4 text-gray-800">Resumen de líneas</h3>
                    <input type="text" id="search-internacional" class="search-input" placeholder="Buscar en la tabla...">
                    <div class="overflow-x-auto" style="max-height: 400px; overflow-y: auto;">
                        <table id="table-internacional"></table>
                    </div>
                </div>
            </div>
        </div>

        <div id="content-general" class="tab-content">
            <div class="loading" id="loading-general">
                <div class="spinner"></div>
            </div>
            <div id="data-general" style="display: none;">
                <div class="grid grid-cols-1 md:grid-cols-4 gap-6 mb-8" id="kpis-general"></div>
                <div class="grid grid-cols-1 lg:grid-cols-2 gap-6 mb-8">
                    <div class="data-card">
                        <h3 class="text-xl font-semibold mb-4 text-gray-800">Distribución de niveles de alineamiento</h3>
                        <div class="chart-container">
                            <canvas id="chart-general-1"></canvas>
                        </div>
                    </div>
                    <div class="data-card">
                        <h3 class="text-xl font-semibold mb-4 text-gray-800">Promedio de alineamiento</h3>
                        <div class="chart-container">
                            <canvas id="chart-general-2"></canvas>
                        </div>
                        <div id="stats-general" class="mt-4 text-center"></div>
                    </div>
                </div>
                <div class="data-card">
                    <h3 class="text-xl font-semibold mb-4 text-gray-800">Resumen de líneas</h3>
                    <input type="text" id="search-general" class="search-input" placeholder="Buscar en la tabla...">
                    <div class="overflow-x-auto" style="max-height: 400px; overflow-y: auto;">
                        <table id="table-general"></table>
                    </div>
                </div>
            </div>
        </div>
    </div>

    <footer class="py-6 mt-12" style="background: linear-gradient(135deg, #1d4ed8 0%, #3b82f6 100%); color: white;">
        <div class="container mx-auto px-4 text-center">
            <p class="text-sm md:text-base">
                Elaborado por <span class="font-semibold">Catalina Santos</span> - Estudiante de enfermería IX Semestre
            </p>
        </div>
    </footer>

    <script>
        // FUENTES DE DATOS: URLs PUBLICADAS COMO CSV DE GOOGLE SHEETS
        const DATA_SOURCES = {
            nacional: 'https://docs.google.com/spreadsheets/d/e/2PACX-1vR3D2ho2jJV0hYbNOzVweclC4SYDifw5AGMEV8HO318cgxpl9tz4nkocubdFCrxxOX7Z8DZ21Ex-1IG/pub?gid=563980265&single=true&output=csv',
            internacional: 'https://docs.google.com/spreadsheets/d/e/2PACX-1vR3D2ho2jJV0hYbNOzVweclC4SYDifw5AGMEV8HO318cgxpl9tz4nkocubdFCrxxOX7Z8DZ21Ex-1IG/pub?gid=804794750&single=true&output=csv',
            general: 'https://docs.google.com/spreadsheets/d/e/2PACX-1vR3D2ho2jJV0hYbNOzVweclC4SYDifw5AGMEV8HO318cgxpl9tz4nkocubdFCrxxOX7Z8DZ21Ex-1IG/pub?gid=24842196&single=true&output=csv'
        };

        let dataCache = {};
        let chartsCache = {};
        let currentSort = { column: null, direction: 'asc' }; 

        // Función para generar una tarjeta KPI mejorada
        function createKpiCard(label, value, color) {
            return `
                <div class="kpi-card-improved border-t-4" style="border-color: ${color};">
                    <div class="kpi-value text-gray-900">${value}</div>
                    <div class="kpi-label mt-1" style="color: ${color};">${label}</div>
                </div>
            `;
        }

        function switchTab(tabName) {
            document.querySelectorAll('.tab-content').forEach(el => el.classList.remove('active'));
            document.querySelectorAll('.tab-button').forEach(el => el.classList.remove('active'));
            
            document.getElementById(`content-${tabName}`).classList.add('active');
            document.getElementById(`tab-${tabName}`).classList.add('active');

            if (!dataCache[tabName]) {
                loadData(tabName);
            } else {
                document.getElementById(`data-${tabName}`).style.display = 'block';
                if (!chartsCache[tabName] || chartsCache[tabName].length === 0) {
                    renderCharts(tabName, dataCache[tabName]);
                }
            }
        }

        function loadData(source) {
            Papa.parse(DATA_SOURCES[source], {
                download: true,
                header: true,
                complete: function(results) {
                    dataCache[source] = results.data.filter(row => {
                        return Object.values(row).some(val => val && val.toString().trim() !== '');
                    });
                    renderDashboard(source, dataCache[source]);
                },
                error: function(error) {
                    console.error('Error loading data:', error);
                    document.getElementById(`loading-${source}`).innerHTML = 
                        '<div class="text-red-600 text-center"><p class="text-xl">❌ Error al cargar los datos</p><p class="mt-2">Verifica la URL, la conexión y que la hoja esté publicada correctamente como CSV.</p></div>';
                }
            });
        }

        function renderDashboard(source, data) {
            document.getElementById(`loading-${source}`).style.display = 'none';
            document.getElementById(`data-${source}`).style.display = 'block';

            renderKPIs(source, data);
            renderCharts(source, data);
            renderTable(source, data);
            setupSearch(source, data);
            
            currentSort = { column: null, direction: 'asc' };
        }

        function renderKPIs(source, data) {
            const kpisContainer = document.getElementById(`kpis-${source}`);
            const analysis = analyzeAlignmentData(data);
            
            const kpis = [
                { label: 'Total de líneas', value: data.length, color: '#1d4ed8' }, // Azul fuerte
                { label: 'Nivel alto (≥80%)', value: analysis.alto, color: '#10b981' }, // Verde
                { label: 'Nivel medio (40-79%)', value: analysis.medio, color: '#f59e0b' }, // Amarillo
                { label: 'Nivel bajo (<40%)', value: analysis.bajo, color: '#ef4444' } // Rojo
            ];

            kpisContainer.innerHTML = kpis.map(kpi => createKpiCard(kpi.label, kpi.value, kpi.color)).join('');
        }

        function analyzeAlignmentData(data) {
            let alto = 0, medio = 0, bajo = 0;
            let totalPercentage = 0;
            let countWithPercentage = 0;

            const possiblePercentageNames = ['%alineamiento', 'alineamiento', 'porcentaje', '%global', 'porcentajeglobal', 'unnamed:4', 'unnamed:3'];
            let percentageColumn = null;

            for (const rowKey in data[0]) {
                const normalizedKey = rowKey.toLowerCase().replace(/[^a-z0-9%]/g, '');
                if (possiblePercentageNames.includes(normalizedKey)) {
                    percentageColumn = rowKey;
                    break;
                }
            }
            if (!percentageColumn) {
                percentageColumn = Object.keys(data[0]).find(col => col.toLowerCase().includes('%'));
            }

            data.forEach(row => {
                if (percentageColumn && row[percentageColumn]) {
                    const rawValue = row[percentageColumn].toString().replace('%', '').replace(',', '.').trim();
                    const percentage = parseFloat(rawValue);

                    if (!isNaN(percentage)) {
                        totalPercentage += percentage;
                        countWithPercentage++;

                        if (percentage >= 80) alto++;
                        else if (percentage >= 40) medio++;
                        else bajo++;
                    }
                }
            });

            return {
                alto,
                medio,
                bajo,
                promedio: countWithPercentage > 0 ? Math.round(totalPercentage / countWithPercentage) : 0
            };
        }


        function renderCharts(source, data) {
            if (chartsCache[source]) {
                chartsCache[source].forEach(chart => chart.destroy());
            }
            chartsCache[source] = [];

            const analysis = analyzeAlignmentData(data);

            // Chart 1: Doughnut Chart
            const ctx1 = document.getElementById(`chart-${source}-1`).getContext('2d');
            const chart1 = new Chart(ctx1, {
                type: 'doughnut',
                data: {
                    labels: [`Alto (≥80% - ${analysis.alto})`, `Medio (40-79% - ${analysis.medio})`, `Bajo (<40% - ${analysis.bajo})`],
                    datasets: [{
                        data: [analysis.alto, analysis.medio, analysis.bajo],
                        backgroundColor: [
                            'rgba(16, 185, 129, 0.9)', // Green
                            'rgba(245, 158, 11, 0.9)', // Yellow
                            'rgba(239, 68, 68, 0.9)'   // Red
                        ],
                        borderColor: 'white',
                        borderWidth: 2
                    }]
                },
                options: {
                    responsive: true,
                    maintainAspectRatio: false,
                    plugins: {
                        legend: { 
                            display: true, 
                            position: 'bottom',
                            labels: {
                                font: { size: 14 },
                                padding: 15
                            }
                        }
                    }
                }
            });
            chartsCache[source].push(chart1);

            // Chart 2: Bar Chart for Average Alignment
            const ctx2 = document.getElementById(`chart-${source}-2`).getContext('2d');
            const chart2 = new Chart(ctx2, {
                type: 'bar',
                data: {
                    labels: ['Promedio de Alineamiento'],
                    datasets: [{
                        label: 'Porcentaje',
                        data: [analysis.promedio],
                        backgroundColor: analysis.promedio >= 80 ? 'rgba(16, 185, 129, 0.8)' : 
                                               analysis.promedio >= 40 ? 'rgba(245, 158, 11, 0.8)' : 
                                               'rgba(239, 68, 68, 0.8)',
                        borderColor: 'transparent',
                        borderWidth: 1
                    }]
                },
                options: {
                    responsive: true,
                    maintainAspectRatio: false,
                    indexAxis: 'y',
                    plugins: {
                        legend: { display: false }
                    },
                    scales: {
                        x: { 
                            beginAtZero: true,
                            max: 100,
                            ticks: {
                                callback: function(value) {
                                    return value + '%';
                                }
                            }
                        }
                    }
                }
            });
            chartsCache[source].push(chart2);

            // Stats Div
            const statsDiv = document.getElementById(`stats-${source}`);
            const nivelText = analysis.promedio >= 80 ? 'Alto' : analysis.promedio >= 40 ? 'Medio' : 'Bajo';
            const nivelColor = analysis.promedio >= 80 ? '#10b981' : analysis.promedio >= 40 ? '#f59e0b' : '#ef4444';
            statsDiv.innerHTML = `
                <div class="text-center p-4 bg-gray-50 rounded-lg border-2 border-dashed" style="border-color: ${nivelColor};">
                    <div class="text-5xl font-extrabold mb-2" style="color: ${nivelColor};">${analysis.promedio}%</div>
                    <div class="text-lg text-gray-700">Nivel de Alineamiento: <span class="font-semibold" style="color: ${nivelColor};">${nivelText}</span></div>
                </div>
            `;
        }

        function renderTable(source, data) {
            const table = document.getElementById(`table-${source}`);
            if (data.length === 0) {
                table.innerHTML = '<p class="text-center text-gray-500 p-4">No hay datos disponibles</p>';
                return;
            }

            const columns = Object.keys(data[0]);
            
            let html = '<thead><tr>';
            columns.forEach(col => {
                const cleanCol = col.replace(/[^a-zA-Z0-9]/g, ''); 
                html += `<th class="cursor-pointer" onclick="sortTable('${source}', '${col}', this)">${col} <span id="sort-icon-${cleanCol}">↕</span></th>`;
            });
            html += '</tr></thead><tbody>';
            
            data.forEach(row => {
                html += '<tr>';
                columns.forEach(col => {
                    html += `<td>${row[col] || ''}</td>`;
                });
                html += '</tr>';
            });
            
            html += '</tbody>';
            table.innerHTML = html;
        }

        function setupSearch(source, data) {
            const searchInput = document.getElementById(`search-${source}`);
            searchInput.oninput = function(e) {
                const searchTerm = e.target.value.toLowerCase();
                const filteredData = dataCache[source].filter(row => { 
                    return Object.values(row).some(val => 
                        val && val.toString().toLowerCase().includes(searchTerm)
                    );
                });
                renderTable(source, filteredData);
            };
        }

        function sortTable(source, column, headerElement) {
            const data = dataCache[source];

            if (currentSort.column === column) {
                currentSort.direction = currentSort.direction === 'asc' ? 'desc' : 'asc';
            } else {
                currentSort.column = column;
                currentSort.direction = 'asc';
            }

            let isNumeric = false;
            const firstNumericRow = data.find(row => row[column] && !isNaN(parseFloat(row[column].toString().replace('%', '').replace(',', '.'))));
            if (firstNumericRow) {
                isNumeric = true;
            }
            
            data.sort((a, b) => {
                const aVal = a[column] || (isNumeric ? 0 : '');
                const bVal = b[column] || (isNumeric ? 0 : '');

                let comparison = 0;

                if (isNumeric) {
                    const numA = parseFloat(aVal.toString().replace('%', '').replace(',', '.') || 0);
                    const numB = parseFloat(bVal.toString().replace('%', '').replace(',', '.') || 0);
                    comparison = numA - numB;
                } else {
                    comparison = aVal.toString().localeCompare(bVal.toString());
                }

                return currentSort.direction === 'asc' ? comparison : -comparison;
            });

            renderTable(source, data);

            document.querySelectorAll(`#table-${source} th span`).forEach(span => {
                span.innerHTML = '↕';
            });

            const iconSpan = headerElement.querySelector('span');
            if (currentSort.direction === 'asc') {
                iconSpan.innerHTML = '▲';
            } else {
                iconSpan.innerHTML = '▼';
            }
        }

        // Carga la pestaña Nacional al iniciar
        loadData('nacional');
    </script>
</body>
</html>
