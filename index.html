<!DOCTYPE html>
<html lang="es">
<head>
<meta charset="utf-8" />
<meta name="viewport" content="width=device-width,initial-scale=1" />
<title>Dashboard CERS – Villavicencio (auto-CSV)</title>

<!-- Fuentes y libs -->
<link href="https://fonts.googleapis.com/css2?family=Montserrat:wght@300;400;600;700&display=swap" rel="stylesheet">
<script src="https://cdn.jsdelivr.net/npm/chart.js@4.4.3/dist/chart.umd.min.js"></script>
<script src="https://cdnjs.cloudflare.com/ajax/libs/PapaParse/5.3.2/papaparse.min.js"></script>

<style>
:root{
  --primario:#1a4369;
  --sec:#00bcd4;
  --alto:#28a745;
  --medio:#ffc107;
  --bajo:#dc3545;
  --fondo:#eef1f5;
  --card:#ffffff;
  --muted:#6c757d;
}
*{box-sizing:border-box}
body{font-family:'Montserrat',sans-serif;margin:0;background:var(--fondo);color:#222}
header{display:flex;align-items:center;justify-content:space-between;padding:14px 22px;background:var(--card);border-bottom:5px solid var(--primario)}
header img{height:54px}
.header-center{text-align:center;flex:1}
h1{margin:0;color:var(--primario);font-size:1.4rem;font-weight:700}
.subtitle{color:var(--muted);font-size:.9rem;margin-top:4px}

/* Tabs */
.tabs{display:flex;gap:10px;justify-content:center;padding:12px;background:var(--primario);flex-wrap:wrap}
.tab-btn{background:#163653;color:#fff;border:0;padding:10px 16px;border-radius:8px;cursor:pointer;font-weight:700}
.tab-btn.active{background:var(--sec);color:#003242}
.container{max-width:1300px;margin:20px auto;padding:0 16px}

/* Panels */
.panel{display:none;background:var(--card);padding:18px;border-radius:10px;box-shadow:0 6px 18px rgba(15,23,42,0.06);margin-bottom:20px}
.panel.active{display:block}
.title{color:var(--primario);font-weight:700;font-size:1.15rem;margin-bottom:6px}
.muted{color:var(--muted);margin-bottom:12px}

/* grid & cards */
.grid-2{display:grid;grid-template-columns:1fr 1fr;gap:14px;margin-bottom:12px}
.grid-3{display:grid;grid-template-columns:repeat(3,1fr);gap:14px;margin-bottom:12px}
.card{background:#fff;padding:12px;border-radius:8px;border:1px solid #e9f0f6}
.kpi{display:flex;flex-direction:column;gap:6px;padding:10px;border-radius:8px;background:#fafcff;border-left:6px solid var(--primario)}
.kpi .label{font-size:.9rem;color:var(--muted)}
.kpi .value{font-size:1.6rem;font-weight:800}

/* table */
.table-wrap{overflow:auto;border-radius:8px;border:1px solid #e6eef6;background:#fff}
table{width:100%;border-collapse:collapse;font-size:.95rem}
th,td{padding:10px;border-bottom:1px solid #eef6fb;text-align:left}
thead th{background:var(--primario);color:#fff}
tbody tr:nth-child(even){background:#fbfdff}

/* validation */
.validation-list{max-height:420px;overflow:auto;border-radius:8px;padding:8px;background:#fff;border:1px solid #e6eef6}
.validation-item{display:flex;gap:10px;align-items:flex-start;padding:8px;border-bottom:1px solid #f3f8fb}
.validation-item:last-child{border-bottom:0}
.btn{padding:8px 10px;border-radius:6px;border:0;cursor:pointer;font-weight:700}
.ok{background:var(--alto);color:#fff}
.pend{background:var(--medio);color:#003242}
.rej{background:var(--bajo);color:#fff}
.small{font-size:.85rem;color:var(--muted)}

/* responsive */
@media (max-width:900px){
  .grid-2,.grid-3{grid-template-columns:1fr}
  header{flex-direction:column;gap:10px}
  .tabs{padding:8px}
}
</style>
</head>
<body>

<header>
  <img src="logos/alcaldia.png" alt="alcaldia">
  <div class="header-center">
    <h1>Dashboard de Alineación CERS / OPS — Villavicencio</h1>
    <div class="subtitle">Carga automática desde las hojas publicadas (CSV)</div>
  </div>
  <img src="logos/unillanos.png" alt="unillanos">
</header>

<div class="tabs" role="tablist" aria-label="Secciones">
  <button class="tab-btn active" data-target="panel-nal">Referentes Nacionales</button>
  <button class="tab-btn" data-target="panel-int">Referentes Internacionales</button>
  <button class="tab-btn" data-target="panel-mat">Matriz General</button>
  <button class="tab-btn" data-target="panel-val">Validación Técnica</button>
</div>

<div class="container">

  <!-- NACIONALES -->
  <section id="panel-nal" class="panel active" role="region" aria-label="Referentes Nacionales">
    <div class="title">Referentes Nacionales</div>
    <div class="muted">Datos cargados desde la hoja pública: <strong>MATRIZ REFERENTES NACIONALES</strong></div>

    <div style="display:flex;gap:10px;align-items:center;margin-bottom:10px;flex-wrap:wrap">
      <div class="small">Fuente:</div>
      <a id="link-nal" href="#" target="_blank" class="small">CSV Nacional</a>
      <button id="refresh-nal" class="btn" style="background:#163653;color:#fff">Recargar</button>
    </div>

    <div class="grid-3" style="margin-bottom:12px">
      <div class="card kpi"><div class="label">Total ítems</div><div id="nal-total" class="value">—</div></div>
      <div class="card kpi"><div class="label">Alto (≥80%)</div><div id="nal-alto" class="value">—</div></div>
      <div class="card kpi"><div class="label">Bajo (<40%)</div><div id="nal-bajo" class="value">—</div></div>
    </div>

    <div class="grid-2">
      <div class="card"><h4 style="margin:0 0 8px">Distribución por nivel</h4><canvas id="chartNalLevels" height="200"></canvas></div>
      <div class="card"><h4 style="margin:0 0 8px">Alineamiento % por línea</h4><canvas id="chartNalLines" height="200"></canvas></div>
    </div>

    <div style="margin-top:14px" class="card">
      <div style="display:flex;gap:8px;align-items:center;margin-bottom:8px">
        <label class="small">Filtrar nivel:</label>
        <select id="filter-nal"><option value="all">Todos</option><option>Alto</option><option>Medio</option><option>Bajo</option></select>
        <button id="export-nal" class="btn" style="background:var(--primario);color:#fff">Exportar CSV</button>
      </div>
      <div class="table-wrap" id="tablewrap-nal"><table id="table-nal"><thead><tr><th>Línea / Ítem</th><th>Alineamiento (%)</th><th>Nivel</th><th>Recomendación</th></tr></thead><tbody><tr><td colspan="4" class="small">Cargando...</td></tr></tbody></table></div>
    </div>
  </section>

  <!-- INTERNACIONALES -->
  <section id="panel-int" class="panel" role="region" aria-label="Referentes Internacionales">
    <div class="title">Referentes Internacionales</div>
    <div class="muted">Datos cargados desde la hoja pública: <strong>MATRIZ REFERENTES INTERNACIONAL</strong></div>

    <div style="display:flex;gap:10px;align-items:center;margin-bottom:10px;flex-wrap:wrap">
      <div class="small">Fuente:</div>
      <a id="link-int" href="#" target="_blank" class="small">CSV Internacional</a>
      <button id="refresh-int" class="btn" style="background:#163653;color:#fff">Recargar</button>
    </div>

    <div class="grid-2" style="margin-bottom:12px">
      <div class="card kpi"><div class="label">Total ítems</div><div id="int-total" class="value">—</div></div>
      <div class="card kpi"><div class="label">Alto (≥80%)</div><div id="int-alto" class="value">—</div></div>
    </div>

    <div class="card" style="margin-top:8px">
      <h4 style="margin:0 0 8px">Comparativo por nivel</h4>
      <canvas id="chartIntCompare" height="220"></canvas>
    </div>

    <div style="margin-top:12px" class="card">
      <div class="table-wrap" id="tablewrap-int"><table id="table-int"><thead><tr><th>Ítem</th><th>Alineamiento (%)</th><th>Nivel</th><th>Recomendación</th></tr></thead><tbody><tr><td colspan="4" class="small">Cargando...</td></tr></tbody></table></div>
    </div>
  </section>

  <!-- MATRIZ GENERAL -->
  <section id="panel-mat" class="panel" role="region" aria-label="Matriz General">
    <div class="title">Matriz General Consolidada</div>
    <div class="muted">Datos cargados desde la hoja pública: <strong>MATRIZ GENERAL</strong></div>

    <div style="display:flex;gap:10px;align-items:center;margin-bottom:10px;flex-wrap:wrap">
      <div class="small">Fuente:</div>
      <a id="link-mat" href="#" target="_blank" class="small">CSV Matriz general</a>
      <button id="refresh-mat" class="btn" style="background:#163653;color:#fff">Recargar</button>
    </div>

    <div class="grid-2" style="margin-bottom:12px">
      <div class="card kpi"><div class="label">Promedio de alineamiento</div><div id="mat-prom" class="value">—</div></div>
      <div class="card kpi"><div class="label">Ítems totales</div><div id="mat-total" class="value">—</div></div>
    </div>

    <div class="card" style="margin-bottom:12px">
      <h4 style="margin:0 0 8px">Mapa de calor / Barras</h4>
      <canvas id="chartMatBars" height="220"></canvas>
    </div>

    <div class="card">
      <div style="display:flex;gap:8px;align-items:center;margin-bottom:10px">
        <label class="small">Buscar:</label>
        <input id="search-mat" type="search" placeholder="Escribe palabra clave..." style="padding:8px;border-radius:6px;border:1px solid #e6eef6;flex:1">
        <button id="export-mat" class="btn" style="background:var(--primario);color:#fff">Exportar CSV</button>
      </div>
      <div class="table-wrap" id="tablewrap-mat"><table id="table-mat"><thead><tr><th>Línea estratégica / Eje</th><th>Alineamiento (%)</th><th>Nivel</th><th>Recomendación</th></tr></thead><tbody><tr><td colspan="4" class="small">Cargando...</td></tr></tbody></table></div>
    </div>
  </section>

  <!-- VALIDACION -->
  <section id="panel-val" class="panel" role="region" aria-label="Validación técnica">
    <div class="title">Validación Técnica — Comité</div>
    <div class="muted">Marca cada ítem como <strong>Aprobado</strong>, <strong>Pendiente</strong> o <strong>No aprobado</strong>. Guarda en local y descarga CSV.</div>

    <div style="display:flex;gap:12px;margin-bottom:12px;flex-wrap:wrap">
      <button id="save-valid" class="btn" style="background:var(--primario);color:#fff">Guardar local</button>
      <button id="download-valid" class="btn" style="background:var(--sec);color:#003242">Descargar CSV</button>
      <button id="clear-valid" class="btn" style="background:#444;color:#fff">Limpiar</button>
    </div>

    <div class="grid-2">
      <div class="card">
        <h4 style="margin:0 0 8px">Lista de ítems</h4>
        <div id="validation-list" class="validation-list"><div class="small">Cargando ítems de la matriz...</div></div>
      </div>

      <div class="card">
        <h4 style="mar
