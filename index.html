<!DOCTYPE html>
<html lang="es">
<head>
<meta charset="utf-8" />
<meta name="viewport" content="width=device-width,initial-scale=1" />
<title>Dashboard CERS – Villavicencio (Síntesis General)</title>

<link href="https://fonts.googleapis.com/css2?family=Montserrat:wght@300;400;600;700&display=swap" rel="stylesheet">
<script src="https://cdn.jsdelivr.net/npm/chart.js@4.4.3/dist/chart.umd.min.js"></script>
<script src="https://cdnjs.cloudflare.com/ajax/libs/PapaParse/5.3.2/papaparse.min.js"></script>

<style>
:root{
  --primario:#1a4369;
  --sec:#00bcd4;
  --alto:#28a745;
  --medio:#ffc107;
  --bajo:#dc3545;
  --fondo:#eef1f5;
  --card:#ffffff;
  --muted:#6c757d;
}
*{box-sizing:border-box}
body{font-family:'Montserrat',sans-serif;margin:0;background:var(--fondo);color:#222}
header{display:flex;align-items:center;justify-content:space-between;padding:14px 22px;background:var(--card);border-bottom:5px solid var(--primario)}
header img{height:54px}
.header-center{text-align:center;flex:1}
h1{margin:0;color:var(--primario);font-size:1.4rem;font-weight:700}
.subtitle{color:var(--muted);font-size:.9rem;margin-top:4px}

/* Tabs - Reducidos al mínimo */
.tabs{display:flex;gap:10px;justify-content:center;padding:12px;background:var(--primario);flex-wrap:wrap; display: none !important;} /* Ocultamos si solo hay una pestaña */
.tab-btn{background:#163653;color:#fff;border:0;padding:10px 16px;border-radius:8px;cursor:pointer;font-weight:700}
.tab-btn.active{background:var(--sec);color:#003242}
.container{max-width:1300px;margin:20px auto;padding:0 16px}

/* Panels */
.panel{display:none;background:var(--card);padding:18px;border-radius:10px;box-shadow:0 6px 18px rgba(15,23,42,0.06);margin-bottom:20px}
.panel.active{display:block}
.title{color:var(--primario);font-weight:700;font-size:1.15rem;margin-bottom:6px}
.muted{color:var(--muted);margin-bottom:12px}

/* grid & cards */
.grid-2{display:grid;grid-template-columns:1fr 1fr;gap:14px;margin-bottom:12px}
.grid-3{display:grid;grid-template-columns:repeat(3,1fr);gap:14px;margin-bottom:12px}
.card{background:#fff;padding:12px;border-radius:8px;border:1px solid #e9f0f6}
.kpi{display:flex;flex-direction:column;gap:6px;padding:10px;border-radius:8px;background:#fafcff;border-left:6px solid var(--primario)}
.kpi .label{font-size:.9rem;color:var(--muted)}
.kpi .value{font-size:1.6rem;font-weight:800}

/* table */
.table-wrap{overflow:auto;border-radius:8px;border:1px solid #e6eef6;background:#fff}
table{width:100%;border-collapse:collapse;font-size:.95rem}
th,td{padding:10px;border-bottom:1px solid #eef6fb;text-align:left}
thead th{background:var(--primario);color:#fff}
tbody tr:nth-child(even){background:#fbfdff}

/* Indicador de Sincronización */
.sync-status {
    padding: 6px 10px;
    border-radius: 6px;
    font-weight: 700;
    font-size: 0.8rem;
    background: var(--alto);
    color: #fff;
    white-space: nowrap; 
}
/* responsive */
@media (max-width:900px){
  .grid-2,.grid-3{grid-template-columns:1fr}
  header{flex-direction:column;gap:10px}
  .tabs{padding:8px}
}
</style>
</head>
<body>

<header>
  <img src="logos/alcaldia.png" alt="alcaldia">
  <div class="header-center">
    <h1>Dashboard de Alineación CERS / OPS — Síntesis General</h1>
    <div class="subtitle">Carga automática desde la Matriz Consolidada (CSV)</div>
  </div>
  <img src="logos/unillanos.png" alt="unillanos">
</header>

<div class="tabs" role="tablist" aria-label="Secciones">
  <button class="tab-btn active" data-target="panel-general">Síntesis General</button> 
</div>

<div class="container">

  <section id="panel-general" class="panel active" role="region" aria-label="Síntesis General">
    <div class="title">Síntesis General Consolidada</div>
    <div class="muted">Datos cargados desde la hoja pública: <strong>MATRIZ GENERAL</strong></div>

    <div style="display:flex;gap:10px;align-items:center;margin-bottom:10px;flex-wrap:wrap">
      <div class="small">Fuente:</div>
      <a id="link-general" href="#" target="_blank" class="small">CSV Matriz general</a>
      <button id="refresh-general" class="btn" style="background:#163653;color:#fff">Recargar</button>
      <span class="sync-status">Sincronizado</span>
    </div>

    <div class="grid-2" style="margin-bottom:12px">
      <div class="card kpi"><div class="label">Promedio de alineamiento</div><div id="general-prom" class="value">—</div></div>
      <div class="card kpi"><div class="label">Ítems totales</div><div id="general-total" class="value">—</div></div>
    </div>

    <div class="card" style="margin-bottom:12px">
      <h4 style="margin:0 0 8px">Distribución por nivel</h4>
      <canvas id="chartGeneralLevels" height="220"></canvas>
    </div>

    <div class="card">
      <div style="display:flex;gap:8px;align-items:center;margin-bottom:10px">
        <label class="small">Buscar:</label>
        <input id="search-general" type="search" placeholder="Escribe palabra clave..." style="padding:8px;border-radius:6px;border:1px solid #e6eef6;flex:1">
      </div>
      <div class="table-wrap" id="tablewrap-general"><table id="table-general"><thead><tr><th>Línea estratégica / Eje</th><th>Alineamiento (%)</th><th>Nivel</th><th>Recomendación</th></tr></thead><tbody><tr><td colspan="4" class="small">Cargando...</td></tr></tbody></table></div>
    </div>
  </section>
  
  </div> <script>
/*
  URLs CSV (públicas en Google Sheets) - Usamos solo la Matriz General
*/
const URL_GENERAL = 'https://docs.google.com/spreadsheets/d/e/2PACX-1vR3D2ho2jJV0hYbNOzVweclC4SYDifw5AGMEV8HO318cgxpl9tz4nkocubdFCrxxOX7Z8DZ21Ex-1IG/pub?gid=24842196&single=true&output=csv';

/* Global caches */
let dataGeneral = [];
let chartGeneralLevels=null;

/* ---------- Utilidades ---------- */
function toNumber(v){ 
  if(v===undefined||v===null||v==='') return 0; 
  const s=String(v).replace('%','').replace(',','.').trim(); 
  const n=Number(s); 
  return isNaN(n)?0:n; 
}
function formatPct(v){ 
  const n=toNumber(v); 
  if ((v===0 || v==='0' || v==='') && n===0) return '0.0%';
  return isNaN(n)?'':n.toFixed(1)+'%'; 
}
function truncate(s,n=80){ if(s===undefined||s===null) return ''; s=String(s); return s.length>n? s.slice(0,n-1)+'…': s; }
function getCSSVar(name, fallback){ try{ const v = getComputedStyle(document.documentElement).getPropertyValue(name); return (v||fallback).trim(); }catch(e){ return fallback; } }


/* ------------------ Render tabla simple ------------------ */
function renderTable(wrapperSelector, data, cols){
  const wrap = document.querySelector(wrapperSelector);
  if(!wrap) return;
  if(!data || data.length === 0){
    const head = `<thead><tr>${cols.map(c=>`<th>${c}</th>`).join('')}</tr></thead>`;
    wrap.innerHTML = `<table>${head}<tbody><tr><td colspan="${cols.length}" class="small">No hay datos</td></tr></tbody></table>`;
    return;
  }
  const head = `<thead><tr>${cols.map(c=>`<th>${c}</th>`).join('')}</tr></thead>`;
  const body = data.map(r=>`<tr>${cols.map(c=>`<td>${r[c]!==undefined?r[c]:''}</td>`).join('')}</tr>`).join('');
  wrap.innerHTML = `<table>${head}<tbody>${body}</tbody></table>`;
}

/* ------------------ Carga CSV con PapaParse (promisified) ------------------ */
function loadCSV(url){
  return new Promise((resolve, reject) => {
    Papa.parse(url, {
      download: true,
      header: true,
      skipEmptyLines: true,
      complete: (res) => {
        if(res && res.data) resolve(res.data);
        else reject(new Error('No se obtuvo data (revise el formato del archivo CSV).'));
      },
      error: (err) => {
        let errMsg = 'Error de red o al descargar el archivo CSV. Verifique la URL de publicación.';
        if (err && err.message) {
            errMsg = err.message;
        }
        reject(new Error(errMsg)); 
      }
    });
  });
}

/* ========== Helpers (Mejorado) ========== */
function escapeHTML(s){ if(s===undefined||s===null) return ''; return String(s).replace(/&/g,'&amp;').replace(/</g,'&lt;').replace(/>/g,'&gt;').replace(/"/g,'&quot;'); }
function guessCol(rows, candidates){
  if(!rows || rows.length===0) return candidates[0];
  const keys = Object.keys(rows[0]||{});
  
  // 1. Búsqueda de coincidencia exacta (limpiando espacios)
  for(const cand of candidates){
    const cleanCand = cand.toLowerCase().trim();
    const found = keys.find(k => k.toLowerCase().trim() === cleanCand);
    if(found) return found;
  }

  // 2. Búsqueda de palabra clave corta
  for(const cand of candidates){
    const keyword = cand.toLowerCase().trim().split(' ')[0];
    const found = keys.find(k => k.toLowerCase().includes(keyword));
    if(found) return found;
  }
  
  // 3. Devolver la primera clave
  return keys[0] || candidates[0];
}

/* ========== SÍNTESIS GENERAL ========== */
async function refreshGeneral(){
  try{
    document.getElementById('link-general').href = URL_GENERAL;
    const rows = await loadCSV(URL_GENERAL);
    dataGeneral = rows.map(r=>{
      const out = {};
      Object.keys(r).forEach(k=> out[k.trim()] = (typeof r[k] === 'string') ? r[k].trim() : r[k]);
      return out;
    });

    // Búsqueda de columnas con nombres universales y cortos
    const colLinea = guessCol(dataGeneral, ['Línea', 'Eje', 'Descripción', 'Item', 'Col1', 'Línea estratégica / Eje']);
    const colPorc  = guessCol(dataGeneral, ['Porcentaje', 'Alineamiento', '%', 'Avance', 'Col2']);
    const colNivel = guessCol(dataGeneral, ['Nivel', 'Categoria', 'Col3']);
    const colRec   = guessCol(dataGeneral, ['Recomendación', 'Observación', 'Col4']);

    const mapped = dataGeneral.map(r => ({
      linea: r[colLinea] || '',
      porcentajeNum: toNumber(r[colPorc]),
      porcentaje: formatPct(r[colPorc]),
      nivel: r[colNivel] || '',
      recomendacion: r[colRec] || ''
    }));

    const total = mapped.length;
    const prom = mapped.reduce((s,i)=> s + (i.porcentajeNum||0), 0) / Math.max(1, total);
    document.getElementById('general-total').innerText = total;
    document.getElementById('general-prom').innerText = prom.toFixed(1) + '%';
    
    // Charts (Distribución por nivel)
    const counts = [
      dataGeneral.filter(r => toNumber(r[colPorc]) < 40).length,
      dataGeneral.filter(r => toNumber(r[colPorc]) >= 40 && toNumber(r[colPorc]) < 80).length,
      dataGeneral.filter(r => toNumber(r[colPorc]) >= 80).length
    ];
    
    // Fallback si la columna de porcentaje no fue numérica
    if (counts.every(c => c === 0) && dataGeneral.length > 0 && colNivel) {
       dataGeneral.forEach(r=>{
          const nivel = String((r[colNivel]||'')).toLowerCase();
          if (nivel.includes('alto')) counts[2]++;
          else if (nivel.includes('medio')) counts[1]++;
          else counts[0]++;
      });
    }


    if(chartGeneralLevels) chartGeneralLevels.destroy();
    chartGeneralLevels = new Chart(document.getElementById('chartGeneralLevels'), {
      type: 'doughnut',
      data: { labels: ['Bajo','Medio','Alto'], datasets: [{ data: counts, backgroundColor: [getCSSVar('--bajo','#dc3545'), getCSSVar('--medio','#ffc107'), getCSSVar('--alto','#28a745')] }] },
      options: { plugins: { legend: { position: 'top' } } }
    });

    // Table
    renderTable('#tablewrap-general', mapped.map(x=> ({ 'Línea estratégica / Eje': x.linea, 'Alineamiento (%)': x.porcentaje, 'Nivel': x.nivel, 'Recomendación': x.recomendacion })), ['Línea estratégica / Eje','Alineamiento (%)','Nivel','Recomendación']);

    // Search
    document.getElementById('search-general').oninput = (e) => {
      const q = e.target.value.trim().toLowerCase();
      const fil = mapped.filter(it => (it.linea + ' ' + it.recomendacion + ' ' + it.nivel).toLowerCase().includes(q));
      renderTable('#tablewrap-general', fil.map(x=> ({ 'Línea estratégica / Eje': x.linea, 'Alineamiento (%)': x.porcentaje, 'Nivel': x.nivel, 'Recomendación': x.recomendacion })), ['Línea estratégica / Eje','Alineamiento (%)','Nivel','Recomendación']);
    };

    return true;
  } catch (err) {
    console.error('Error GENERAL:', err);
    alert('Error al cargar la síntesis general: ' + (err.message || String(err)));
    return false;
  }
}

/* ========== UI wiring: tabs & refresh buttons ========== */
document.getElementById('refresh-general').onclick = refreshGeneral;

/* ========== STARTUP: run sequentially to avoid race conditions ========== */
async function initAll(){
  try{
    await refreshGeneral();
  } catch(e){
    console.error('Error en initAll:', e);
    alert('Error iniciando el dashboard: ' + (e.message || String(e)));
  }
}

/* Run */
initAll();

</script>
</body>
</html>
