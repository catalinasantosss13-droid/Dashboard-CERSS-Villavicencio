<!DOCTYPE html>
<html lang="es">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Dashboard BI - CERS 2025 Villavicencio</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <script src="https://cdn.jsdelivr.net/npm/chart.js@4.4.0/dist/chart.umd.min.js"></script>
    <script src="https://cdn.jsdelivr.net/npm/papaparse@5.4.1/papaparse.min.js"></script>
    <style>
        .tab-content { display: none; }
        .tab-content.active { display: block; }
        .tab-button.active { 
            background-color: #3b82f6; 
            color: white; 
        }
        .kpi-card {
            background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
            color: white;
            padding: 1.5rem;
            border-radius: 0.5rem;
            box-shadow: 0 4px 6px rgba(0, 0, 0, 0.1);
        }
        .chart-container {
            position: relative;
            height: 400px;
            margin-bottom: 2rem;
        }
        table {
            border-collapse: collapse;
            width: 100%;
            background: white;
            box-shadow: 0 1px 3px rgba(0, 0, 0, 0.1);
        }
        th {
            background-color: #1f2937;
            color: white;
            padding: 1rem;
            text-align: left;
            font-weight: 600;
            position: sticky;
            top: 0;
            z-index: 10;
        }
        td {
            padding: 0.75rem 1rem;
            border-bottom: 1px solid #e5e7eb;
        }
        tr:hover {
            background-color: #f9fafb;
        }
        .search-input {
            width: 100%;
            padding: 0.75rem;
            border: 2px solid #e5e7eb;
            border-radius: 0.5rem;
            margin-bottom: 1rem;
            font-size: 1rem;
        }
        .search-input:focus {
            outline: none;
            border-color: #3b82f6;
        }
        .loading {
            display: flex;
            justify-content: center;
            align-items: center;
            min-height: 300px;
        }
        .spinner {
            border: 4px solid #f3f4f6;
            border-top: 4px solid #3b82f6;
            border-radius: 50%;
            width: 50px;
            height: 50px;
            animation: spin 1s linear infinite;
        }
        @keyframes spin {
            0% { transform: rotate(0deg); }
            100% { transform: rotate(360deg); }
        }
    </style>
</head>
<body class="bg-gray-50">
    <div class="container mx-auto px-4 py-8 max-w-7xl">
        <!-- Header -->
        <header class="mb-8 bg-white rounded-lg shadow-md p-6">
            <div class="flex flex-col md:flex-row items-center justify-between gap-4">
                <div class="flex items-center gap-4">
                    <img src="logos/unillanos.png" alt="Universidad de los Llanos" class="h-16 md:h-20">
                    <img src="logos/alcaldia.png" alt="Alcaldía de Villavicencio" class="h-16 md:h-20">
                </div>
                <div class="text-center md:text-right">
                    <h1 class="text-3xl md:text-4xl font-bold text-gray-800 mb-2">Dashboard Analítico BI</h1>
                    <p class="text-gray-600 text-lg">Matriz Comparativa CERS 2025 - Villavicencio</p>
                </div>
            </div>
        </header>

        <!-- Tabs Navigation -->
        <div class="mb-6 flex flex-wrap gap-2 border-b-2 border-gray-200">
            <button onclick="switchTab('nacional')" class="tab-button active px-6 py-3 font-semibold rounded-t-lg transition-all" id="tab-nacional">
                Nacional
            </button>
            <button onclick="switchTab('internacional')" class="tab-button px-6 py-3 font-semibold rounded-t-lg transition-all" id="tab-internacional">
                Internacional
            </button>
            <button onclick="switchTab('general')" class="tab-button px-6 py-3 font-semibold rounded-t-lg transition-all" id="tab-general">
                General
            </button>
        </div>

        <!-- Nacional Tab -->
        <div id="content-nacional" class="tab-content active">
            <div class="loading" id="loading-nacional">
                <div class="spinner"></div>
            </div>
            <div id="data-nacional" style="display: none;">
                <!-- KPIs -->
                <div class="grid grid-cols-1 md:grid-cols-4 gap-4 mb-8" id="kpis-nacional"></div>
                
                <!-- Charts -->
                <div class="grid grid-cols-1 lg:grid-cols-2 gap-6 mb-8">
                    <div class="bg-white p-6 rounded-lg shadow">
                        <h3 class="text-xl font-semibold mb-4 text-gray-800">Distribución de Niveles de Alineamiento</h3>
                        <div class="chart-container">
                            <canvas id="chart-nacional-1"></canvas>
                        </div>
                    </div>
                    <div class="bg-white p-6 rounded-lg shadow">
                        <h3 class="text-xl font-semibold mb-4 text-gray-800">Promedio de Alineamiento</h3>
                        <div class="chart-container">
                            <canvas id="chart-nacional-2"></canvas>
                        </div>
                        <div id="stats-nacional" class="mt-4 text-center"></div>
                    </div>
                </div>

                <!-- Data Table -->
                <div class="bg-white p-6 rounded-lg shadow">
                    <h3 class="text-xl font-semibold mb-4 text-gray-800">Resumen de Datos</h3>
                    <input type="text" id="search-nacional" class="search-input" placeholder="Buscar...">
                    <div class="overflow-x-auto" style="max-height: 400px; overflow-y: auto;">
                        <table id="table-nacional"></table>
                    </div>
                </div>
            </div>
        </div>

        <!-- Internacional Tab -->
        <div id="content-internacional" class="tab-content">
            <div class="loading" id="loading-internacional">
                <div class="spinner"></div>
            </div>
            <div id="data-internacional" style="display: none;">
                <!-- KPIs -->
                <div class="grid grid-cols-1 md:grid-cols-4 gap-4 mb-8" id="kpis-internacional"></div>
                
                <!-- Charts -->
                <div class="grid grid-cols-1 lg:grid-cols-2 gap-6 mb-8">
                    <div class="bg-white p-6 rounded-lg shadow">
                        <h3 class="text-xl font-semibold mb-4 text-gray-800">Distribución de Niveles de Alineamiento</h3>
                        <div class="chart-container">
                            <canvas id="chart-internacional-1"></canvas>
                        </div>
                    </div>
                    <div class="bg-white p-6 rounded-lg shadow">
                        <h3 class="text-xl font-semibold mb-4 text-gray-800">Promedio de Alineamiento</h3>
                        <div class="chart-container">
                            <canvas id="chart-internacional-2"></canvas>
                        </div>
                        <div id="stats-internacional" class="mt-4 text-center"></div>
                    </div>
                </div>

                <!-- Data Table -->
                <div class="bg-white p-6 rounded-lg shadow">
                    <h3 class="text-xl font-semibold mb-4 text-gray-800">Resumen de Datos</h3>
                    <input type="text" id="search-internacional" class="search-input" placeholder="Buscar...">
                    <div class="overflow-x-auto" style="max-height: 400px; overflow-y: auto;">
                        <table id="table-internacional"></table>
                    </div>
                </div>
            </div>
        </div>

        <!-- General Tab -->
        <div id="content-general" class="tab-content">
            <div class="loading" id="loading-general">
                <div class="spinner"></div>
            </div>
            <div id="data-general" style="display: none;">
                <!-- KPIs -->
                <div class="grid grid-cols-1 md:grid-cols-4 gap-4 mb-8" id="kpis-general"></div>
                
                <!-- Charts -->
                <div class="grid grid-cols-1 lg:grid-cols-2 gap-6 mb-8">
                    <div class="bg-white p-6 rounded-lg shadow">
                        <h3 class="text-xl font-semibold mb-4 text-gray-800">Distribución de Niveles de Alineamiento</h3>
                        <div class="chart-container">
                            <canvas id="chart-general-1"></canvas>
                        </div>
                    </div>
                    <div class="bg-white p-6 rounded-lg shadow">
                        <h3 class="text-xl font-semibold mb-4 text-gray-800">Promedio de Alineamiento</h3>
                        <div class="chart-container">
                            <canvas id="chart-general-2"></canvas>
                        </div>
                        <div id="stats-general" class="mt-4 text-center"></div>
                    </div>
                </div>

                <!-- Data Table -->
                <div class="bg-white p-6 rounded-lg shadow">
                    <h3 class="text-xl font-semibold mb-4 text-gray-800">Resumen de Datos</h3>
                    <input type="text" id="search-general" class="search-input" placeholder="Buscar...">
                    <div class="overflow-x-auto" style="max-height: 400px; overflow-y: auto;">
                        <table id="table-general"></table>
                    </div>
                </div>
            </div>
        </div>
    </div>

    <!-- Footer -->
    <footer class="bg-gray-800 text-white py-6 mt-12">
        <div class="container mx-auto px-4 text-center">
            <p class="text-sm md:text-base">
                Elaborado por <span class="font-semibold">Catalina Santos</span> - Estudiante de enfermería IX Semestre
            </p>
        </div>
    </footer>

    <script>
        const DATA_SOURCES = {
            nacional: 'https://docs.google.com/spreadsheets/d/e/2PACX-1vR3D2ho2jJV0hYbNOzVweclC4SYDifw5AGMEV8HO318cgxpl9tz4nkocubdFCrxxOX7Z8DZ21Ex-1IG/pub?gid=563980265&single=true&output=csv',
            internacional: 'https://docs.google.com/spreadsheets/d/e/2PACX-1vR3D2ho2jJV0hYbNOzVweclC4SYDifw5AGMEV8HO318cgxpl9tz4nkocubdFCrxxOX7Z8DZ21Ex-1IG/pub?gid=804794750&single=true&output=csv',
            general: 'https://docs.google.com/spreadsheets/d/e/2PACX-1vR3D2ho2jJV0hYbNOzVweclC4SYDifw5AGMEV8HO318cgxpl9tz4nkocubdFCrxxOX7Z8DZ21Ex-1IG/pub?gid=24842196&single=true&output=csv'
        };

        let dataCache = {};
        let chartsCache = {};

        function switchTab(tabName) {
            document.querySelectorAll('.tab-content').forEach(el => el.classList.remove('active'));
            document.querySelectorAll('.tab-button').forEach(el => el.classList.remove('active'));
            
            document.getElementById(`content-${tabName}`).classList.add('active');
            document.getElementById(`tab-${tabName}`).classList.add('active');

            if (!dataCache[tabName]) {
                loadData(tabName);
            }
        }

        function loadData(source) {
            Papa.parse(DATA_SOURCES[source], {
                download: true,
                header: true,
                complete: function(results) {
                    dataCache[source] = results.data.filter(row => {
                        return Object.values(row).some(val => val && val.toString().trim() !== '');
                    });
                    renderDashboard(source, dataCache[source]);
                },
                error: function(error) {
                    console.error('Error loading data:', error);
                    document.getElementById(`loading-${source}`).innerHTML = 
                        '<div class="text-red-600 text-center"><p class="text-xl">❌ Error al cargar los datos</p><p class="mt-2">Por favor, verifica la conexión a internet</p></div>';
                }
            });
        }

        function renderDashboard(source, data) {
            document.getElementById(`loading-${source}`).style.display = 'none';
            document.getElementById(`data-${source}`).style.display = 'block';

            renderKPIs(source, data);
            renderCharts(source, data);
            renderTable(source, data);
            setupSearch(source, data);
        }

        function renderKPIs(source, data) {
            const kpisContainer = document.getElementById(`kpis-${source}`);
            const analysis = analyzeAlignmentData(data);
            
            const kpis = [
                { label: 'Total de Líneas', value: data.length, color: '#2563eb' },
                { label: 'Nivel Alto (≥80%)', value: analysis.alto, color: '#10b981' },
                { label: 'Nivel Medio (40-79%)', value: analysis.medio, color: '#f59e0b' },
                { label: 'Nivel Bajo (<40%)', value: analysis.bajo, color: '#ef4444' }
            ];

            kpisContainer.innerHTML = kpis.map(kpi => `
                <div class="bg-white p-6 rounded-lg shadow-md border-l-4" style="border-color: ${kpi.color};">
                    <div class="text-3xl font-bold mb-1" style="color: ${kpi.color};">${kpi.value}</div>
                    <div class="text-sm text-gray-600 font-medium">${kpi.label}</div>
                </div>
            `).join('');
        }

        function analyzeAlignmentData(data) {
            let alto = 0, medio = 0, bajo = 0;
            let totalPercentage = 0;
            let countWithPercentage = 0;

            const nivelColumn = findColumn(data, ['nivel de avance', 'nivel', 'avance']);
            const percentageColumn = findColumn(data, ['% alineamiento', 'alineamiento', 'porcentaje']);

            data.forEach(row => {
                let nivel = '';
                if (nivelColumn) {
                    nivel = (row[nivelColumn] || '').toString().toLowerCase();
                } else if (percentageColumn) {
                    const percentage = parseFloat(row[percentageColumn]);
                    if (!isNaN(percentage)) {
                        if (percentage >= 80) nivel = 'alto';
                        else if (percentage >= 40) nivel = 'medio';
                        else nivel = 'bajo';
                    }
                }

                if (nivel.includes('alto')) alto++;
                else if (nivel.includes('medio')) medio++;
                else if (nivel.includes('bajo')) bajo++;

                if (percentageColumn) {
                    const percentage = parseFloat(row[percentageColumn]);
                    if (!isNaN(percentage)) {
                        totalPercentage += percentage;
                        countWithPercentage++;
                    }
                }
            });

            return {
                alto,
                medio,
                bajo,
                promedio: countWithPercentage > 0 ? Math.round(totalPercentage / countWithPercentage) : 0
            };
        }

        function findColumn(data, possibleNames) {
            if (data.length === 0) return null;
            const columns = Object.keys(data[0]);
            for (let name of possibleNames) {
                const found = columns.find(col => col.toLowerCase().includes(name));
                if (found) return found;
            }
            return null;
        }

        function calculateCompleteness(data) {
            if (data.length === 0) return '0%';
            const totalCells = data.length * Object.keys(data[0]).length;
            const filledCells = data.reduce((sum, row) => {
                return sum + Object.values(row).filter(val => val && val.toString().trim() !== '').length;
            }, 0);
            return Math.round((filledCells / totalCells) * 100) + '%';
        }

        function renderCharts(source, data) {
            if (chartsCache[source]) {
                chartsCache[source].forEach(chart => chart.destroy());
            }
            chartsCache[source] = [];

            const analysis = analyzeAlignmentData(data);

            const ctx1 = document.getElementById(`chart-${source}-1`).getContext('2d');
            const chart1 = new Chart(ctx1, {
                type: 'doughnut',
                data: {
                    labels: ['Alto (≥80%)', 'Medio (40-79%)', 'Bajo (<40%)'],
                    datasets: [{
                        data: [analysis.alto, analysis.medio, analysis.bajo],
                        backgroundColor: [
                            'rgba(16, 185, 129, 0.8)',
                            'rgba(245, 158, 11, 0.8)',
                            'rgba(239, 68, 68, 0.8)'
                        ],
                        borderColor: [
                            'rgb(16, 185, 129)',
                            'rgb(245, 158, 11)',
                            'rgb(239, 68, 68)'
                        ],
                        borderWidth: 2
                    }]
                },
                options: {
                    responsive: true,
                    maintainAspectRatio: false,
                    plugins: {
                        legend: { 
                            display: true, 
                            position: 'bottom',
                            labels: {
                                font: { size: 14 },
                                padding: 15
                            }
                        }
                    }
                }
            });
            chartsCache[source].push(chart1);

            const ctx2 = document.getElementById(`chart-${source}-2`).getContext('2d');
            const chart2 = new Chart(ctx2, {
                type: 'bar',
                data: {
                    labels: ['Promedio de Alineamiento'],
                    datasets: [{
                        label: 'Porcentaje',
                        data: [analysis.promedio],
                        backgroundColor: analysis.promedio >= 80 ? 'rgba(16, 185, 129, 0.8)' : 
                                       analysis.promedio >= 40 ? 'rgba(245, 158, 11, 0.8)' : 
                                       'rgba(239, 68, 68, 0.8)',
                        borderColor: analysis.promedio >= 80 ? 'rgb(16, 185, 129)' : 
                                    analysis.promedio >= 40 ? 'rgb(245, 158, 11)' : 
                                    'rgb(239, 68, 68)',
                        borderWidth: 2
                    }]
                },
                options: {
                    responsive: true,
                    maintainAspectRatio: false,
                    indexAxis: 'y',
                    plugins: {
                        legend: { display: false }
                    },
                    scales: {
                        x: { 
                            beginAtZero: true,
                            max: 100,
                            ticks: {
                                callback: function(value) {
                                    return value + '%';
                                }
                            }
                        }
                    }
                }
            });
            chartsCache[source].push(chart2);

            const statsDiv = document.getElementById(`stats-${source}`);
            const nivelText = analysis.promedio >= 80 ? 'Alto' : analysis.promedio >= 40 ? 'Medio' : 'Bajo';
            const nivelColor = analysis.promedio >= 80 ? '#10b981' : analysis.promedio >= 40 ? '#f59e0b' : '#ef4444';
            statsDiv.innerHTML = `
                <div class="text-center p-4 bg-gray-50 rounded-lg">
                    <div class="text-5xl font-bold mb-2" style="color: ${nivelColor};">${analysis.promedio}%</div>
                    <div class="text-lg text-gray-700">Nivel de Alineamiento: <span class="font-semibold" style="color: ${nivelColor};">${nivelText}</span></div>
                </div>
            `;
        }

        function renderTable(source, data) {
            const table = document.getElementById(`table-${source}`);
            if (data.length === 0) {
                table.innerHTML = '<p class="text-center text-gray-500 p-4">No hay datos disponibles</p>';
                return;
            }

            const columns = Object.keys(data[0]);
            
            let html = '<thead><tr>';
            columns.forEach(col => {
                html += `<th class="cursor-pointer" onclick="sortTable('${source}', '${col}')">${col} <span style="font-size:10px;">↕</span></th>`;
            });
            html += '</tr></thead><tbody id="tbody-${source}">';
            
            data.forEach(row => {
                html += '<tr>';
                columns.forEach(col => {
                    html += `<td>${row[col] || ''}</td>`;
                });
                html += '</tr>';
            });
            
            html += '</tbody>';
            table.innerHTML = html;
        }

        function setupSearch(source, data) {
            const searchInput = document.getElementById(`search-${source}`);
            searchInput.addEventListener('input', function(e) {
                const searchTerm = e.target.value.toLowerCase();
                const filteredData = data.filter(row => {
                    return Object.values(row).some(val => 
                        val && val.toString().toLowerCase().includes(searchTerm)
                    );
                });
                renderTable(source, filteredData);
            });
        }

        function sortTable(source, column) {
            const data = dataCache[source];
            const isNumeric = !isNaN(parseFloat(data[0][column]));
            
            data.sort((a, b) => {
                const aVal = a[column];
                const bVal = b[column];
                
                if (isNumeric) {
                    return parseFloat(aVal || 0) - parseFloat(bVal || 0);
                } else {
                    return (aVal || '').toString().localeCompare((bVal || '').toString());
                }
            });
            
            renderTable(source, data);
        }

        loadData('nacional');
    </script>
</body>
</html>
