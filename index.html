<!DOCTYPE html>
<html lang="es">
<head>
<meta charset="utf-8" />
<meta name="viewport" content="width=device-width,initial-scale=1" />
<title>Dashboard CERS – Villavicencio (auto-CSV)</title>
<link href="https://fonts.googleapis.com/css2?family=Montserrat:wght@300;400;600;700&display=swap" rel="stylesheet">
<script src="https://cdn.jsdelivr.net/npm/chart.js@4.4.3/dist/chart.umd.min.js"></script>
<script src="https://cdnjs.cloudflare.com/ajax/libs/PapaParse/5.3.2/papaparse.min.js"></script>
<style>
/* same styles as user provided – unchanged */
</style>
</head>
<body>
<!-- same HTML layout as provided – unchanged -->

<script>
/* helpers */
function getCSSVar(v,fallback){return getComputedStyle(document.documentElement).getPropertyValue(v).trim()||fallback;}
function truncate(t,n){return t&&t.length>n?t.slice(0,n)+"…":t;}
function normalizeRow(r){const o={};for(const k in r){o[k.trim()] = r[k];}return o;}
function guessCol(rows,cands){if(!rows.length) return cands[0];
 const cols=Object.keys(rows[0]);
 for(const c of cands){const hit=cols.find(x=> x.toLowerCase().includes(c.toLowerCase())); if(hit) return hit;}
 return cols[0];}

/* CSV loader */
function loadCSV(url){return new Promise((resolve,reject)=>{
 Papa.parse(url,{download:true,header:true,skipEmptyLines:true,
   complete:r=>resolve(r.data),error:err=>reject(err)});
});}

/* ========================= URLs ========================= */
const URL_MATRIZ = "https://docs.google.com/spreadsheets/d/e/2PACX-1vR3D2ho2jJV0hYbNOzVweclC4SYDifw5AGMEV8HO318cgxpl9tz4nkocubdFCrxxOX7Z8DZ21Ex-1IG/pub?gid=1428307109&single=true&output=csv";
const URL_NAL = "https://docs.google.com/spreadsheets/d/e/2PACX-1vR3D2ho2jJV0hYbNOzVweclC4SYDifw5AGMEV8HO318cgxpl9tz4nkocubdFCrxxOX7Z8DZ21Ex-1IG/pub?gid=607322215&single=true&output=csv";
const URL_INT = "https://docs.google.com/spreadsheets/d/e/2PACX-1vR3D2ho2jJV0hYbNOzVweclC4SYDifw5AGMEV8HO318cgxpl9tz4nkocubdFCrxxOX7Z8DZ21Ex-1IG/pub?gid=113039783&single=true&output=csv";

let dataNal=[], dataInt=[], dataMat=[];
let chartNalLevels, chartNalLines, chartIntCompare, chartMatBars;

/* number utils */
function toNumber(v){ if(!v) return 0; return Number(String(v).replace('%','').replace(',','.')); }
function formatPct(v){const n=toNumber(v); return isNaN(n)?'':n.toFixed(1)+'%';}
function toCSV(rows){ if(!rows.length) return ''; let keys=Object.keys(rows[0]);
 let out=[keys.join(',')];
 rows.forEach(r=>{
  out.push(keys.map(k=>{
   let v=r[k]??''; v=String(v).replace(/"/g,'""');
   return /[",\n]/.test(v)?`"${v}"`:v;
  }).join(','));
 });
 return out.join("\n"); }
function downloadCSV(txt,name){const b=new Blob([txt],{type:"text/csv"}); const u=URL.createObjectURL(b); const a=document.createElement('a'); a.href=u; a.download=name; a.click(); setTimeout(()=>URL.revokeObjectURL(u),1000); }

/* =================== RENDER TABLE =================== */
function renderTable(sel,data,cols){
 const wrap=document.querySelector(sel);
 if(!wrap)return;
 if(!data.length){ wrap.innerHTML='<table><tbody><tr><td>No hay datos</td></tr></tbody></table>'; return; }
 let head='<thead><tr>'+cols.map(c=>`<th>${c}</th>`).join('')+'</tr></thead>';
 let body=data.map(r=>'<tr>'+cols.map(c=>`<td>${r[c]||''}</td>`).join('')+'</tr>').join('');
 wrap.innerHTML=`<table>${head}<tbody>${body}</tbody></table>`;
}

/* =================== NACIONALES =================== */
async function refreshNacionales(){
 try{
  document.getElementById('link-nal').href=URL_NAL;
  const arr = await loadCSV(URL_NAL);
  dataNal = arr.map(normalizeRow);

  const colLinea = guessCol(dataNal,['Linea','Línea','Ítem']);
  const colPorc = guessCol(dataNal,['Alineamiento','%']);
  const colNivel = guessCol(dataNal,['Nivel']);
  const colRec = guessCol(dataNal,['Recomendación','Observación']);

  document.getElementById('nal-total').textContent = dataNal.length;
  document.getElementById('nal-alto').textContent = dataNal.filter(r=>toNumber(r[colPorc])>=80).length;
  document.getElementById('nal-bajo').textContent = dataNal.filter(r=>toNumber(r[colPorc])<40).length;

  renderTable('#tablewrap-nal', dataNal.map(r=>({
     [colLinea]:truncate(r[colLinea],120),
     [colPorc]:formatPct(r[colPorc]),
     [colNivel]:r[colNivel]||'',
     [colRec]:r[colRec]||''
  })), [colLinea,colPorc,colNivel,colRec]);

  const counts=[
   dataNal.filter(r=>toNumber(r[colPorc])<40).length,
   dataNal.filter(r=>toNumber(r[colPorc])>=40 && toNumber(r[colPorc])<80).length,
   dataNal.filter(r=>toNumber(r[colPorc])>=80).length
  ];

  if(chartNalLevels) chartNalLevels.destroy();
  chartNalLevels=new Chart(document.getElementById('chartNalLevels'),{
   type:'doughnut', data:{labels:['Bajo','Medio','Alto'],datasets:[{data:counts,backgroundColor:[getCSSVar('--bajo'),getCSSVar('--medio'),getCSSVar('--alto')]}]},
   options:{plugins:{legend:{position:'top'}}}
  });

  const labels=dataNal.slice(0,30).map(r=>truncate(r[colLinea],40));
  const valores=dataNal.slice(0,30).map(r=>toNumber(r[colPorc]));
  if(chartNalLines)chartNalLines.destroy();
  chartNalLines=new Chart(document.getElementById('chartNalLines'),{
   type:'bar', data:{labels, datasets:[{data:valores,backgroundColor: valores.map(v=> v>=80?getCSSVar('--alto'): v>=40?getCSSVar('--medio'):getCSSVar('--bajo'))}]},
   options:{indexAxis:'y',scales:{x:{max:100,beginAtZero:true}}}
  });

  document.getElementById('export-nal').onclick=()=>{
    downloadCSV(toCSV(dataNal), 'referentes_nacionales.csv');
  };

 }catch(e){console.error(e); alert('Error cargando nacionales');}
}

/* =================== INTERNACIONALES =================== */
async function refreshInternacionales(){
 try{
  document.getElementById('link-int').href=URL_INT;
  const arr=await loadCSV(URL_INT);
  dataInt=arr.map(normalizeRow);

  const colItem=guessCol(dataInt,['Ítem','Item']);
  const colPorc=guessCol(dataInt,['Alineamiento','%']);
  const colNivel=guessCol(dataInt,['Nivel']);
  const colRec=guessCol(dataInt,['Recomendación','Observación']);

  document.getElementById('int-total').textContent=dataInt.length;
  document.getElementById('int-alto').textContent=dataInt.filter(r=>toNumber(r[colPorc])>=80).length;

  renderTable('#tablewrap-int', dataInt.map(r=>({
    [colItem]:truncate(r[colItem],120),
    [colPorc]:formatPct(r[colPorc]),
    [colNivel]:r[colNivel]||'',
    [colRec]:r[colRec]||''
  })), [colItem,colPorc,colNivel,colRec]);

  const counts=[
    dataInt.filter(r=>toNumber(r[colPorc])<40).length,
    dataInt.filter(r=>toNumber(r[colPorc])>=40 && toNumber(r[colPorc])<80).length,
    dataInt.filter(r=>toNumber(r[colPorc])>=80).length
  ];

  if(chartIntCompare)chartIntCompare.destroy();
  chartIntCompare=new Chart(document.getElementById('chartIntCompare'),{
    type:'bar', data:{labels:['Bajo','Medio','Alto'],datasets:[{data:counts,backgroundColor:[getCSSVar('--bajo'),getCSSVar('--medio'),getCSSVar('--alto')]}]},
    options:{plugins:{legend:{display:false}}}
  });

 }catch(e){console.error(e); alert('Error cargando internacionales');}
}

/* =================== MATRIZ GENERAL =================== */
async function refreshMatriz(){
 try{
  document.getElementById('link-mat').href=URL_MATRIZ;
  const arr=await loadCSV(URL_MATRIZ);
  dataMat=arr.map(normalizeRow);

  const colLinea=guessCol(dataMat,['Línea','Linea','Eje']);
  const colPorc=guessCol(dataMat,['Alineamiento','%']);
  const colNivel=guessCol(dataMat,['Nivel']);
  const colRec=guessCol(dataMat,['Recomendación','Observación']);

  document.getElementById('mat-total').textContent=dataMat.length;
  const prom = dataMat.reduce((a,b)=>a+toNumber(b[colPorc]),0)/dataMat.length;
  document.getElementById('mat-prom').textContent=prom.toFixed(1)+'%';

  const labels=dataMat.slice(0,40).map(r=>truncate(r[colLinea],40));
  const valores=dataMat.slice(0,40).map(r=>toNumber(r[colPorc]));
  if(chartMatBars)chartMatBars.destroy();
  chartMatBars=new Chart(document.getElementById('chartMatBars'),{
    type:'bar', data:{labels, datasets:[{data:valores, backgroundColor: valores.map(v=> v>=80?getCSSVar('--alto'): v>=40?getCSSVar('--medio'):getCSSVar('--bajo'))}]},
    options:{scales:{y:{beginAtZero:true,max:100}}}
  });

  renderTable('#tablewrap-mat', dataMat.map(r=>({
    [colLinea]:truncate(r[colLinea],120),
    [colPorc]:formatPct(r[colPorc]),
    [colNivel]:r[colNivel]||'',
    [colRec]:r[colRec]||''
  })), [colLinea,colPorc,colNivel,colRec]);

  document.getElementById('export-mat').onclick=()=> downloadCSV(toCSV(dataMat),'matriz_general.csv');

  document.getElementById('search-mat').oninput=(e)=>{
    const q=e.target.value.toLowerCase();
    const filt=dataMat.filter(r=> String(r[colLinea]).toLowerCase().includes(q));
    renderTable('#tablewrap-mat',filt.map(r=>({[colLinea]:truncate(r[colLinea],120),[colPorc]:formatPct(r[colPorc]),[colNivel]:r[colNivel]||'',[colRec]:r[colRec]||''})),[colLinea,colPorc,colNivel,colRec]);
  };

 }catch(e){console.error(e); alert('Error cargando matriz');}
}

/* =================== VALIDACIÓN =================== */
let valState={};
function renderValidation(){
 const list=document.getElementById('validation-list');
 list.innerHTML='';
 const colLinea=guessCol(dataMat,['Línea','Linea','Eje']);
 Object.keys(valState).forEach((k,i)=>{
   const item=document.createElement('div'); item.className='validation-item';
   item.innerHTML=`<div style='flex:1'>${truncate(k,120)}</div>
   <div style='display:flex;gap:4px'>
     <button data-k='${k}' data-v='Aprobado' class='btn ok'>A</button>
     <button data-k='${k}' data-v='Pendiente' class='btn pend'>P</button>
     <button data-k='${k}' data-v='No aprobado' class='btn rej'>N</button>
   </div>`;
   list.appendChild(item);
 });
 updateSummary();
}
function updateSummary(){
 const s=document.getElementById('val-summary');
 let total=Object.keys(valState).length;
 let A=Object.values(valState).filter(v=>v==='Aprobado').length;
 let P=Object.values(valState).filter(v=>v==='Pendiente').length;
 let N=Object.values(valState).filter(v=>v==='No aprobado').length;
 s.innerHTML=`<li>Total: ${total}</li><li>Aprobados: ${A}</li><li>Pendientes: ${P}</li><li>No aprobados: ${N}</li>`;
}

async function initValidation(){
 await refreshMatriz();
 valState={};
 const colLinea=guessCol(dataMat,['Línea','Linea','Eje']);
 dataMat.forEach(r=>{ valState[r[colLinea]]= valState[r[colLinea]]||''; });
 renderValidation();

 document.getElementById('validation-list').onclick=(e)=>{
  if(e.target.dataset.k){ valState[e.target.dataset.k]=e.target.dataset.v; renderValidation(); }
 };
 document.getElementById('save-valid').onclick=()=> localStorage.setItem('validCERS',JSON.stringify(valState));
 document.getElementById('clear-valid').onclick=()=>{valState={};renderValidation();};
 document.getElementById('download-valid').onclick=()=>{
   const rows=Object.keys(valState).map(k=>({item:k,estado:valState[k]}));
   downloadCSV(toCSV(rows),'validacion_cers.csv');
 };
}

/* Tabs */
document.querySelectorAll('.tab-btn').forEach(btn=>{
 btn.onclick=()=>{
  document.querySelectorAll('.tab-btn').forEach(b=>b.classList.remove('active'));
  btn.classList.add('active');
  document.querySelectorAll('.panel').forEach(p=>p.classList.remove('active'));
  document.getElementById(btn.dataset.target).classList.add('active');
 };
});

/* INIT */
refreshNacionales();
refreshInternacionales();
refreshMatriz();
initValidation();
</script>

</body>
</html>
