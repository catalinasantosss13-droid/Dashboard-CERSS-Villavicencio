<!DOCTYPE html>
<html lang="es">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Matriz Comparativa - BI Dashboard</title>
    <script src="https://cdn.jsdelivr.net/npm/chart.js@3.7.1/dist/chart.min.js"></script>
    <style>
        body { 
            font-family: 'Segoe UI', Tahoma, Geneva, Verdana, sans-serif; 
            margin: 0; 
            padding: 20px; 
            background-color: #f4f4f9;
            color: #333;
        }
        h1, h2 { 
            text-align: center; 
            color: #1e3c72; 
            margin-bottom: 20px;
        }
        .container { 
            max-width: 1400px; 
            margin: auto; 
            padding: 20px;
            background-color: #fff;
            box-shadow: 0 4px 8px rgba(0, 0, 0, 0.1);
            border-radius: 8px;
        }
        /* Estilo para el √°rea de gr√°ficos */
        #chart-section {
            padding: 30px 0;
            border-bottom: 2px solid #ccc;
            margin-bottom: 30px;
        }
        #chart-container {
            width: 80%; /* Ancho del contenedor del gr√°fico */
            max-width: 900px;
            margin: 0 auto;
            background-color: #fff;
            padding: 20px;
            border-radius: 8px;
            box-shadow: 0 4px 6px rgba(0, 0, 0, 0.1);
        }
        /* Estilos de tabla (mantenidos del c√≥digo anterior) */
        table { width: 100%; border-collapse: collapse; margin-bottom: 50px; box-shadow: 0 2px 3px rgba(0, 0, 0, 0.1); }
        th, td { border: 1px solid #ddd; padding: 12px 15px; text-align: left; }
        th { background-color: #2a5298; color: white; cursor: pointer; position: sticky; top: 0; user-select: none; }
        th[data-sort-direction="asc"]::after { content: " ‚ñ≤"; }
        th[data-sort-direction="desc"]::after { content: " ‚ñº"; }
        .loading, .error { text-align: center; font-size: 1.1em; padding: 15px; border-radius: 4px; }
        .loading { color: #007bff; }
        .error { color: #dc3545; background-color: #f8d7da; border: 1px solid #f5c6cb; }
        section { padding: 20px 0; border-bottom: 1px dashed #ccc; }
        section:last-of-type { border-bottom: none; }
    </style>
</head>
<body>
    <div class="container">
        <h1>üìä Herramienta BI para Matriz Comparativa</h1>
        <p class="loading" id="loading-message">Cargando datos y generando visualizaciones...</p>

        <section id="chart-section">
            <h2>üìà Gr√°fico de Resumen (Matriz General)</h2>
            <div id="chart-container">
                <canvas id="generalChart"></canvas>
            </div>
        </section>

        <section id="general-section">
            <h2>Matriz GENERAL (Referencia de Datos)</h2>
            <div id="general-table"></div>
        </section>
        
        <section id="nacional-section">
            <h2>Matriz NACIONAL</h2>
            <div id="nacional-table"></div>
        </section>

        <section id="internacional-section">
            <h2>Matriz INTERNACIONAL</h2>
            <div id="internacional-table"></div>
        </section>
        
    </div>

    <script>
        // --- CONFIGURACI√ìN DE MATRICES ---
        const MATRICES = [
            // El orden se cambia para procesar GENERAL primero, si es la fuente principal del gr√°fico.
            {
                name: "GENERAL",
                url: "https://docs.google.com/spreadsheets/d/e/2PACX-1vR3D2ho2jJV0hYbNOzVweclC4SYDifw5AGMEV8HO318cgxpl9tz4nkocubdFCrxxOX7Z8DZ21Ex-1IG/pub?gid=24842196&single=true&output=csv",
                targetId: "general-table",
                skipRows: 1,
                isChartSource: true // Marcamos esta como la fuente de datos para el gr√°fico
            },
            {
                name: "NACIONAL",
                url: "https://docs.google.com/spreadsheets/d/e/2PACX-1vR3D2ho2jJV0hYbNOzVweclC4SYDifw5AGMEV8HO318cgxpl9tz4nkocubdFCrxxOX7Z8DZ21Ex-1IG/pub?gid=563980265&single=true&output=csv",
                targetId: "nacional-table",
                skipRows: 1
            },
            {
                name: "INTERNACIONAL",
                url: "https://docs.google.com/spreadsheets/d/e/2PACX-1vR3D2ho2jJV0hYbNOzVweclC4SYDifw5AGMEV8HO318cgxpl9tz4nkocubdFCrxxOX7Z8DZ21Ex-1IG/pub?gid=804794750&single=true&output=csv",
                targetId: "internacional-table",
                skipRows: 1
            }
        ];

        // --- FUNCIONES CENTRALES (parseCSV y renderTable se mantienen igual) ---

        function parseCSV(csvText, skipRows = 0) {
            const rows = csvText.trim().split('\n').filter(row => row.trim() !== '');
            const dataRows = rows.slice(skipRows);
            return dataRows.map(row => {
                return row.split(/,(?=(?:(?:[^"]*"){2})*[^"]*$)/).map(cell => {
                    let content = cell.trim();
                    if (content.startsWith('"') && content.endsWith('"')) {
                        content = content.slice(1, -1);
                    }
                    return content.trim();
                });
            });
        }

        function renderTable(data, targetId) {
            const container = document.getElementById(targetId);
            if (!data || data.length < 2) {
                container.innerHTML = '<p class="error">No se encontraron datos v√°lidos o el archivo est√° vac√≠o (despu√©s de saltar la fila fantasma).</p>';
                return;
            }

            const headers = data[0];
            const rows = data.slice(1);

            let html = '<table><thead><tr>';
            headers.forEach((header, index) => {
                const headerText = header.replace(/\s+/g, ' ').trim() || `Columna ${index + 1}`;
                html += `<th data-column-index="${index}">${headerText}</th>`;
            });
            html += '</tr></thead><tbody>';

            rows.forEach(row => {
                html += '<tr>';
                row.forEach(cell => {
                    const cellContent = cell.trim() || '&nbsp;';
                    html += `<td>${cellContent}</td>`;
                });
                html += '</tr>';
            });

            html += '</tbody></table>';
            container.innerHTML = html;
        }

        // --- FUNCI√ìN DE GR√ÅFICOS ---

        /**
         * Crea un gr√°fico de barras simple usando los datos de una matriz.
         * ESTA FUNCI√ìN DEBE SER PERSONALIZADA seg√∫n la estructura EXACTA de tu CSV.
         * * @param {Array<Array<string>>} data - Datos parseados de la matriz.
         * @param {number} labelColIndex - √çndice de la columna que ser√° usada como etiqueta (eje X).
         * @param {number} valueColIndex - √çndice de la columna que ser√° usada como valor (eje Y).
         * @param {string} chartTitle - T√≠tulo del gr√°fico.
         */
        function createBarChart(data, labelColIndex, valueColIndex, chartTitle) {
            const chartData = data.slice(1); // Datos sin encabezados

            // 1. Extraer Etiquetas y Valores
            const labels = chartData.map(row => row[labelColIndex] || 'N/A');
            const values = chartData.map(row => {
                // Intenta convertir el valor a un n√∫mero, eliminando separadores de miles (puntos)
                // y usando coma o punto como separador decimal.
                let val = row[valueColIndex].replace(/\./g, '').replace(',', '.');
                return parseFloat(val) || 0; // Si no es un n√∫mero v√°lido, usa 0
            });

            // 2. Preparar el contexto del canvas
            const ctx = document.getElementById('generalChart').getContext('2d');
            
            // 3. Destruir gr√°fico anterior si existe (para prevenir errores al recargar)
            if (window.generalChartInstance) {
                window.generalChartInstance.destroy();
            }

            // 4. Crear el nuevo gr√°fico
            window.generalChartInstance = new Chart(ctx, {
                type: 'bar',
                data: {
                    labels: labels,
                    datasets: [{
                        label: data[0][valueColIndex] || 'Valor', // Usa el encabezado de la columna como etiqueta
                        data: values,
                        backgroundColor: 'rgba(42, 82, 152, 0.8)', // Color de las barras
                        borderColor: 'rgba(42, 82, 152, 1)',
                        borderWidth: 1
                    }]
                },
                options: {
                    responsive: true,
                    plugins: {
                        title: {
                            display: true,
                            text: chartTitle
                        },
                        legend: {
                            display: false
                        }
                    },
                    scales: {
                        y: {
                            beginAtZero: true
                        }
                    }
                }
            });
        }
        
        // --- FUNCI√ìN DE CARGA Y RENDERIZADO (MODIFICADA) ---

        async function fetchAndRenderMatrix(matrixConfig) {
            const container = document.getElementById(matrixConfig.targetId);
            container.innerHTML = `<p class="loading">Cargando ${matrixConfig.name}...</p>`;

            try {
                const response = await fetch(matrixConfig.url);
                if (!response.ok) {
                    throw new Error(`Error HTTP! Estado: ${response.status}`);
                }
                const csvText = await response.text();
                
                const data = parseCSV(csvText, matrixConfig.skipRows);
                
                renderTable(data, matrixConfig.targetId);

                // Si esta matriz est√° marcada como fuente del gr√°fico, generarlo.
                if (matrixConfig.isChartSource) {
                    // *** CONFIGURACI√ìN CLAVE PARA EL GR√ÅFICO ***
                    // ** DEBES AJUSTAR ESTOS √çNDICES **
                    // 1. Columna de Etiquetas (ej. Nombre del Competidor/√çtem)
                    const labelColumn = 0; 
                    // 2. Columna de Valores (ej. Puntaje Total/Resultado Clave)
                    const valueColumn = 5; 
                    // T√≠tulo del Gr√°fico
                    const chartTitle = `Comparativa Clave: ${data[0][labelColumn]} vs. ${data[0][valueColumn]}`;
                    
                    createBarChart(data, labelColumn, valueColumn, chartTitle);
                }
                
            } catch (error) {
                console.error(`Error al cargar la matriz ${matrixConfig.name}:`, error);
                container.innerHTML = `<p class="error">‚ö†Ô∏è Error al cargar los datos de la matriz ${matrixConfig.name}. Detalle: ${error.message}</p>`;
            }
        }
        
        // --- FUNCIONES DE ORDENAMIENTO (Mantenidas) ---
        function addTableSorting() {
            document.querySelectorAll('table').forEach(table => {
                const headers = table.querySelectorAll('th');
                headers.forEach(header => {
                    header.addEventListener('click', () => {
                        const columnIndex = header.getAttribute('data-column-index');
                        sortTableByColumn(table, parseInt(columnIndex));
                    });
                });
            });
        }
        
        function sortTableByColumn(table, column) {
            const tbody = table.querySelector('tbody');
            const rows = Array.from(tbody.querySelectorAll('tr'));
            
            let direction = 'asc';
            const currentColumn = table.getAttribute('data-sort-column');
            const currentDirection = table.getAttribute('data-sort-direction');

            if (currentColumn == column && currentDirection === 'asc') {
                direction = 'desc';
            }
            
            table.setAttribute('data-sort-column', column);
            table.setAttribute('data-sort-direction', direction);
            table.querySelectorAll('th').forEach(th => th.removeAttribute('data-sort-direction'));
            table.querySelector(`th[data-column-index="${column}"]`).setAttribute('data-sort-direction', direction);
            
            const sortedRows = rows.sort((rowA, rowB) => {
                const cellA = rowA.querySelectorAll('td')[column].textContent.trim();
                const cellB = rowB.querySelectorAll('td')[column].textContent.trim();
                
                const valA = parseFloat(cellA.replace(/\./g, '').replace(',', '.'));
                const valB = parseFloat(cellB.replace(/\./g, '').replace(',', '.'));
                
                let comparison;
                if (!isNaN(valA) && !isNaN(valB)) {
                    comparison = valA - valB;
                } else {
                    comparison = cellA.localeCompare(cellB, 'es', { numeric: true, sensitivity: 'base' });
                }
                
                return direction === 'asc' ? comparison : comparison * -1;
            });

            while (tbody.firstChild) {
                tbody.removeChild(tbody.firstChild);
            }
            tbody.append(...sortedRows);
        }

        async function loadAllMatrices() {
            const generalLoading = document.getElementById('loading-message');
            generalLoading.textContent = 'Procesando...';
            
            try {
                const promises = MATRICES.map(fetchAndRenderMatrix);
                await Promise.all(promises);
                
                generalLoading.style.display = 'none';
                addTableSorting();
            } catch(e) {
                 generalLoading.textContent = 'Fallo en la carga. Revisa los errores en la consola.';
            }
        }

        document.addEventListener('DOMContentLoaded', loadAllMatrices);
    </script>
</body>
</html>
