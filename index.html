<!DOCTYPE html>
<html lang="es">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Tablero de Proyección Técnica - CERS</title>
    
    <script src="https://cdn.jsdelivr.net/npm/chart.js@4.4.3/dist/chart.umd.min.js"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/PapaParse/5.3.0/papaparse.min.js"></script>
    <link href="https://fonts.googleapis.com/css2?family=Montserrat:wght@300;400;500;600;700;800&display=swap" rel="stylesheet">
    <link href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/css/all.min.css" rel="stylesheet">
    
    <style>
        :root {
            --primary: #003366; 
            --accent: #00AEEF; 
            --initial: #95a5a6; 
            --final: #27ae60;   
            --bg-light: #f8f9fa;         
            --white: #ffffff;
            --text-dark: #2c3e50;
        }

        body { font-family: 'Montserrat', sans-serif; background-color: var(--bg-light); color: var(--text-dark); margin: 0; padding-bottom: 80px; }

        /* HEADER */
        .header-top {
            background: linear-gradient(135deg, #001a35 0%, var(--primary) 100%);
            color: var(--white); padding: 20px 40px; display: flex; justify-content: space-between; align-items: center;
            box-shadow: 0 4px 20px rgba(0, 0, 0, 0.25);
        }
        .header-info h1 { margin: 0; font-size: 1.5rem; font-weight: 800; }
        .header-info p.subtitle { margin: 5px 0 0; opacity: 0.9; font-size: 0.9rem; font-weight: 300; }
        .header-info p.phase { 
            margin: 8px 0 0; font-size: 0.75rem; color: var(--accent); font-weight: 700; 
            background: rgba(255,255,255,0.1); padding: 4px 10px; border-radius: 20px; display: inline-block;
        }

        /* LOGOS */
        .header-right { text-align: right; }
        .logos-container { display: flex; align-items: center; gap: 12px; background: rgba(255,255,255,0.1); padding: 5px 10px; border-radius: 8px; backdrop-filter: blur(4px); }
        .logos-container img { height: 45px; background: var(--white); padding: 3px; border-radius: 4px; display: block; }

        /* CONTROL BAR */
        .control-bar {
            background-color: var(--white); padding: 15px 40px; display: flex; flex-direction: column; gap: 20px;
            border-bottom: 1px solid #e1e5eb; position: sticky; top: 0; z-index: 900; box-shadow: 0 5px 15px rgba(0,0,0,0.03);
        }
        
        .nav-tabs { display: flex; gap: 15px; overflow-x: auto; padding-bottom: 5px; }
        .tab-btn {
            background: var(--bg-light); border: 1px solid #dcdcdc; padding: 10px 20px; font-family: inherit; font-size: 0.85rem; font-weight: 600;
            color: #7f8c8d; cursor: pointer; border-radius: 50px; transition: all 0.3s; white-space: nowrap;
        }
        .tab-btn:hover { background: #eef7ff; color: var(--primary); }
        .tab-btn.active { background: var(--primary); color: var(--white); border-color: var(--primary); box-shadow: 0 4px 10px rgba(0,0,0,0.1); }

        /* PANEL DE PROYECCIÓN */
        .simulation-panel {
            display: flex; align-items: center; gap: 20px; width: 100%;
            background: #f0fdf4; padding: 15px 25px; border-radius: 12px; border: 1px solid #bbf7d0;
            box-shadow: 0 4px 10px rgba(0,0,0,0.02);
        }
        .sim-icon { font-size: 1.8rem; color: var(--final); }
        .legend-box { display: flex; gap: 20px; font-size: 0.8rem; font-weight: 600; margin-left: auto; }
        .legend-item { display: flex; align-items: center; gap: 6px; }
        .dot { width: 12px; height: 12px; border-radius: 50%; }

        /* CONTAINER */
        .container { max-width: 1300px; margin: 30px auto; padding: 0 30px; }

        /* KPI GRID */
        .kpi-grid { display: grid; grid-template-columns: repeat(3, 1fr); gap: 25px; margin-bottom: 30px; }
        .kpi-card { 
            background: var(--white); padding: 25px; border-radius: 12px; text-align: center; 
            box-shadow: 0 4px 20px rgba(0,0,0,0.04); border-top: 4px solid transparent;
        }
        .kpi-title { font-size: 0.75rem; text-transform: uppercase; letter-spacing: 1px; color: #95a5a6; font-weight: 700; }
        .kpi-value { font-size: 2.5rem; font-weight: 800; display: block; margin-top: 10px; color: var(--text-dark); }
        .kpi-trend { font-size: 0.9rem; font-weight: 700; display: block; margin-top: 5px; color: var(--final); }

        /* CHARTS */
        .chart-card { background: var(--white); padding: 25px; border-radius: 12px; box-shadow: 0 4px 20px rgba(0,0,0,0.04); height: 450px; margin-bottom: 30px;}
        .section-header { margin-bottom: 20px; border-left: 4px solid var(--accent); padding-left: 12px; color: var(--primary); font-size: 1.1rem; font-weight: 700; }

        /* TABLE */
        .table-card { background: var(--white); padding: 25px; border-radius: 12px; box-shadow: 0 4px 20px rgba(0,0,0,0.04); overflow: hidden; }
        .table-responsive { overflow-x: auto; }
        table { width: 100%; border-collapse: collapse; font-size: 0.9rem; }
        th { background: #f8f9fa; color: var(--primary); padding: 15px; text-align: left; border-bottom: 2px solid #eee; font-weight: 700; text-transform: uppercase; font-size: 0.75rem; }
        td { padding: 15px; border-bottom: 1px solid #f0f0f0; vertical-align: middle; color: #4a5568; }
        
        /* INPUT DE PROYECCIÓN */
        .input-proj {
            width: 65px; padding: 6px; border: 1px solid #ccc; border-radius: 4px; 
            text-align: center; font-weight: 700; color: var(--final); background: #fafffb;
        }
        .input-proj:focus { border-color: var(--final); outline: none; background: #fff; }

        .improvement-tag {
            background: #dcfce7; color: var(--final); padding: 4px 8px; border-radius: 4px; 
            font-size: 0.75rem; font-weight: 700; display: inline-flex; align-items: center; gap: 4px;
        }

        /* TOOLTIP DE SUSTENTO TÉCNICO */
        .tooltip-container { position: relative; display: inline-block; cursor: pointer; }
        .tooltip-icon { color: var(--accent); font-size: 1rem; transition: transform 0.2s; }
        .tooltip-icon:hover { transform: scale(1.2); }
        .tooltip-content {
            visibility: hidden; width: 250px; background-color: #333; color: #fff; text-align: left;
            border-radius: 6px; padding: 10px; position: absolute; z-index: 1; bottom: 125%; left: 50%;
            margin-left: -125px; opacity: 0; transition: opacity 0.3s; font-size: 0.75rem; line-height: 1.4;
            box-shadow: 0 4px 15px rgba(0,0,0,0.2);
        }
        .tooltip-content::after {
            content: ""; position: absolute; top: 100%; left: 50%; margin-left: -5px;
            border-width: 5px; border-style: solid; border-color: #333 transparent transparent transparent;
        }
        .tooltip-container:hover .tooltip-content { visibility: visible; opacity: 1; }

        @media (max-width: 900px) { 
            .kpi-grid { grid-template-columns: 1fr; } 
            .simulation-panel { flex-direction: column; align-items: flex-start; }
            .header-top { flex-direction: column; text-align: center; gap: 15px; }
        }
    </style>
</head>
<body>

    <header class="header-top">
        <div class="header-info">
            <h1>ANÁLISIS DE ALINEACIÓN CERS</h1>
            <p class="subtitle">Evaluación de Conformidad y Proyección de Impacto</p>
            <div style="font-size:0.75rem; opacity:0.8; margin-top:5px; font-weight:600;">Investigadora: Catalina Santos Gonzalez</div>
        </div>
        
        <div class="header-right">
            <div class="logos-container">
                <img src="logos/alcaldia.png" alt="Alcaldía">
                <img src="logos/unillanos.png" alt="Unillanos">
            </div>
        </div>
    </header>

    <div class="control-bar">
        <nav class="nav-tabs">
            <button class="tab-btn active" onclick="loadTab('NACIONAL')">1. Ref. Nacionales</button>
            <button class="tab-btn" onclick="loadTab('INTERNACIONAL')">2. Ref. Internacionales</button>
            <button class="tab-btn" onclick="loadTab('GENERAL')">3. Matriz General</button>
        </nav>

        <div class="simulation-panel">
            <div style="display:flex; align-items:center; gap:15px;">
                <i class="fas fa-chart-line sim-icon"></i>
                <div>
                    <strong style="color:var(--primary); font-size:1rem;">Fase 6.2.1.3: VERIFICAR Y PROYECTAR</strong>
                    <div style="font-size:0.8rem; color:#666;">Proyección basada en la implementación de acciones de mejora priorizadas.</div>
                </div>
            </div>
            <div class="legend-box">
                <div class="legend-item"><div class="dot" style="background:var(--initial);"></div> <span>Línea Base</span></div>
                <div class="legend-item"><div class="dot" style="background:var(--final);"></div> <span>Proyección (Meta)</span></div>
            </div>
        </div>
    </div>

    <div class="container">
        
        <div id="loading" style="text-align:center; padding:80px; color:#bdc3c7;">
            <i class="fas fa-spinner fa-spin fa-3x" style="color:var(--primary);"></i>
            <p style="margin-top:15px; font-weight:600;">Generando modelo de proyección técnica...</p>
        </div>

        <div id="dashboard-content" style="display:none;">
            
            <div class="kpi-grid">
                <div class="kpi-card" style="border-top-color: var(--initial);">
                    <span class="kpi-title">Cumplimiento Actual</span>
                    <span class="kpi-value" id="kpi-inicial" style="color:var(--initial);">0%</span>
                </div>
                <div class="kpi-card" style="border-top-color: var(--final);">
                    <span class="kpi-title">Cumplimiento Proyectado</span>
                    <span class="kpi-value" id="kpi-final" style="color:var(--final);">0%</span>
                </div>
                <div class="kpi-card" style="border-top-color: var(--accent);">
                    <span class="kpi-title">Impacto Estimado (Delta)</span>
                    <span class="kpi-value" id="kpi-delta" style="color:var(--accent);">+0%</span>
                    <span class="kpi-trend">Mejora Potencial</span>
                </div>
            </div>

            <div class="chart-card">
                <div class="section-header">Gráfico de Brechas: Estado Actual vs Estado Deseado</div>
                <div style="height: 380px; position: relative;">
                    <canvas id="chartComparativo"></canvas>
                </div>
            </div>

            <div class="table-card">
                <div class="section-header">Matriz de Proyección y Sustento Técnico</div>
                <div class="table-responsive">
                    <table id="tablaDetalle">
                        <thead>
                            <tr>
                                <th style="width: 35%;">Línea Estratégica</th>
                                <th style="width: 12%; text-align:center;">Base</th>
                                <th style="width: 12%; text-align:center;">Meta</th>
                                <th style="width: 12%; text-align:center;">Mejora</th>
                                <th style="width: 15%; text-align:center;">Sustento Técnico</th>
                                <th style="width: 14%; text-align:center;">Escenario</th>
                            </tr>
                        </thead>
                        <tbody></tbody>
                    </table>
                </div>
            </div>
        </div>
    </div>

    <script>
        // CONFIGURACIÓN DE DATOS
        const SHEETS_CONFIG = {
            'GENERAL': {
                url: 'https://docs.google.com/spreadsheets/d/e/2PACX-1vR3D2ho2jJV0hYbNOzVweclC4SYDifw5AGMEV8HO318cgxpl9tz4nkocubdFCrxxOX7Z8DZ21Ex-1IG/pub?gid=1428307109&single=true&output=csv',
                colIndex: { name: 0, pct: 3, rec: 5 } // rec = columna de Recomendación
            },
            'NACIONAL': {
                url: 'https://docs.google.com/spreadsheets/d/e/2PACX-1vR3D2ho2jJV0hYbNOzVweclC4SYDifw5AGMEV8HO318cgxpl9tz4nkocubdFCrxxOX7Z8DZ21Ex-1IG/pub?gid=607322215&single=true&output=csv',
                colIndex: { name: 0, pct: 4, rec: 6 }
            },
            'INTERNACIONAL': {
                url: 'https://docs.google.com/spreadsheets/d/e/2PACX-1vR3D2ho2jJV0hYbNOzVweclC4SYDifw5AGMEV8HO318cgxpl9tz4nkocubdFCrxxOX7Z8DZ21Ex-1IG/pub?gid=113039783&single=true&output=csv',
                colIndex: { name: 0, pct: 4, rec: 6 }
            }
        };

        let currentData = [];
        let chartComparativo = null;

        window.onload = function() { loadTab('NACIONAL'); };

        function loadTab(tabName) {
            document.querySelectorAll('.tab-btn').forEach(btn => btn.classList.remove('active'));
            const activeBtn = Array.from(document.querySelectorAll('.tab-btn')).find(b => b.onclick.toString().includes(`'${tabName}'`));
            if(activeBtn) activeBtn.classList.add('active');

            document.getElementById('loading').style.display = 'block';
            document.getElementById('dashboard-content').style.display = 'none';

            const config = SHEETS_CONFIG[tabName];
            Papa.parse(config.url, {
                download: true, header: false,
                complete: function(results) { processCSV(results.data, config.colIndex); },
                error: function() { alert('Error de conexión.'); }
            });
        }

        function processCSV(data, mapping) {
            const clean = [];
            for (let i = 2; i < data.length; i++) {
                const row = data[i];
                if (row[mapping.name] && row[mapping.name].trim() !== "" && !row[mapping.name].includes("Elaborado por")) {
                    let rawPct = row[mapping.pct];
                    if(typeof rawPct === 'string') rawPct = rawPct.replace('%', '').replace(',', '.');
                    let val = parseFloat(rawPct) || 0;
                    
                    // LÓGICA DE PROYECCIÓN TÉCNICA (Defendible)
                    // "A menor puntaje, mayor margen de mejora técnica"
                    let mejora = 0;
                    if (val < 40) mejora = 20;      // Crítico: Se puede mejorar mucho
                    else if (val < 70) mejora = 15; // Medio: Mejora sustancial
                    else if (val < 90) mejora = 5;  // Alto: Mejora marginal
                    else mejora = 0;                // Óptimo: Mantenimiento

                    let simulado = val + mejora;
                    if (simulado > 100) simulado = 100;

                    clean.push({
                        id: i,
                        linea: row[mapping.name],
                        inicial: val,
                        final: simulado,
                        recomendacion: row[mapping.rec] || "Revisión documental estándar."
                    });
                }
            }
            currentData = clean;
            document.getElementById('loading').style.display = 'none';
            document.getElementById('dashboard-content').style.display = 'block';
            renderDashboard();
        }

        function updateValue(index, newValue) {
            let val = parseFloat(newValue);
            if(isNaN(val)) val = 0;
            if(val > 100) val = 100;

            currentData[index].final = val;
            
            const row = document.getElementById(`row-${index}`);
            const deltaSpan = row.querySelector('.improvement-tag');
            const diff = val - currentData[index].inicial;
            
            if(diff > 0) {
                deltaSpan.innerHTML = `<i class="fas fa-arrow-up"></i> +${Math.round(diff)}%`;
                deltaSpan.style.color = '#27ae60'; deltaSpan.style.background = '#dcfce7';
            } else {
                deltaSpan.innerHTML = `-`;
                deltaSpan.style.color = '#95a5a6'; deltaSpan.style.background = '#f1f1f1';
            }

            updateKPIs();
            updateChart();
        }

        function updateKPIs() {
            const total = currentData.length;
            const avgInit = total ? currentData.reduce((a,b)=>a+b.inicial,0)/total : 0;
            const avgFinal = total ? currentData.reduce((a,b)=>a+b.final,0)/total : 0;
            const delta = avgFinal - avgInit;

            document.getElementById('kpi-inicial').innerText = Math.round(avgInit) + '%';
            document.getElementById('kpi-final').innerText = Math.round(avgFinal) + '%';
            document.getElementById('kpi-delta').innerText = '+' + Math.round(delta) + '%';
        }

        function renderDashboard() {
            updateKPIs();

            const tbody = document.querySelector('#tablaDetalle tbody');
            tbody.innerHTML = '';
            
            currentData.forEach((item, index) => {
                const diff = item.final - item.inicial;
                let escenario = 'Mantenimiento';
                if(diff >= 15) escenario = 'Transformación';
                else if(diff >= 5) escenario = 'Mejora Continua';

                const tr = document.createElement('tr');
                tr.id = `row-${index}`;
                tr.innerHTML = `
                    <td><strong>${item.linea}</strong></td>
                    <td style="text-align:center; color:#95a5a6; font-weight:700;">${item.inicial}%</td>
                    <td style="text-align:center;">
                        <input type="number" class="input-proj" value="${item.final}" 
                        onchange="updateValue(${index}, this.value)" min="0" max="100">
                    </td>
                    <td style="text-align:center;">
                        <span class="improvement-tag"><i class="fas fa-arrow-up"></i> +${Math.round(diff)}%</span>
                    </td>
                    <td style="text-align:center;">
                        <div class="tooltip-container">
                            <i class="fas fa-file-medical-alt tooltip-icon"></i>
                            <span class="tooltip-content">
                                <strong>Acción de Mejora (Base de la Proyección):</strong><br>
                                ${item.recomendacion}
                            </span>
                        </div>
                    </td>
                    <td style="text-align:center; font-size:0.7rem; color:#666;">${escenario}</td>
                `;
                tbody.appendChild(tr);
            });

            updateChart();
        }

        function updateChart() {
            const ctx = document.getElementById('chartComparativo').getContext('2d');
            if (chartComparativo) chartComparativo.destroy();

            const labels = currentData.map(d => d.linea.length > 35 ? d.linea.substring(0,35)+'...' : d.linea);
            
            chartComparativo = new Chart(ctx, {
                type: 'bar',
                data: {
                    labels: labels,
                    datasets: [
                        {
                            label: 'Línea Base',
                            data: currentData.map(d => d.inicial),
                            backgroundColor: '#bdc3c7',
                            borderRadius: 4
                        },
                        {
                            label: 'Meta Proyectada',
                            data: currentData.map(d => d.final),
                            backgroundColor: '#003366',
                            borderRadius: 4
                        }
                    ]
                },
                options: { 
                    indexAxis: 'y', 
                    responsive: true, maintainAspectRatio: false, 
                    scales: { x: { max: 100, grid: {color:'#f0f0f0'} }, y: { grid:{display:false} } }, 
                    plugins: { 
                        legend: { position: 'top', align: 'end' },
                        tooltip: {
                            callbacks: {
                                afterBody: function(context) {
                                    // Mostrar la recomendación en el tooltip del gráfico también
                                    const index = context[0].dataIndex;
                                    return '\nSustento: ' + currentData[index].recomendacion.substring(0, 50) + '...';
                                }
                            }
                        }
                    } 
                }
            });
        }
    </script>
</body>
</html>
