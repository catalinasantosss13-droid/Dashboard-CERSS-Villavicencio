<!DOCTYPE html>
<html lang="es">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Tablero de Verificación de Alineación - CERS</title>
    
    <script src="https://cdn.jsdelivr.net/npm/chart.js@4.4.3/dist/chart.umd.min.js"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/PapaParse/5.3.0/papaparse.min.js"></script>
    <link href="https://fonts.googleapis.com/css2?family=Montserrat:wght@300;400;500;600;700;800&display=swap" rel="stylesheet">
    <link href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/css/all.min.css" rel="stylesheet">
    
    <style>
        :root {
            --primary: #003366; 
            --accent: #00AEEF; 
            --initial: #7f8c8d; /* Gris para dato documental */
            --final: #003366;   /* Azul Corporativo para dato validado */
            --bg-light: #f8f9fa;          
            --white: #ffffff;
            --text-dark: #2c3e50;
        }

        body { font-family: 'Montserrat', sans-serif; background-color: var(--bg-light); color: var(--text-dark); margin: 0; padding-bottom: 80px; }

        /* HEADER */
        .header-top {
            background: linear-gradient(135deg, #001a35 0%, var(--primary) 100%);
            color: var(--white); padding: 20px 40px; display: flex; justify-content: space-between; align-items: center;
            box-shadow: 0 4px 20px rgba(0, 0, 0, 0.25);
        }
        .header-info h1 { margin: 0; font-size: 1.5rem; font-weight: 800; }
        .header-info p.subtitle { margin: 5px 0 0; opacity: 0.9; font-size: 0.9rem; font-weight: 300; }

        /* LOGOS */
        .header-right { text-align: right; }
        .logos-container { display: flex; align-items: center; gap: 12px; background: rgba(255,255,255,0.1); padding: 5px 10px; border-radius: 8px; backdrop-filter: blur(4px); }
        .logos-container img { height: 45px; background: var(--white); padding: 3px; border-radius: 4px; display: block; }

        /* CONTROL BAR */
        .control-bar {
            background-color: var(--white); padding: 15px 40px; display: flex; flex-direction: column; gap: 20px;
            border-bottom: 1px solid #e1e5eb; position: sticky; top: 0; z-index: 900; box-shadow: 0 5px 15px rgba(0,0,0,0.03);
        }
        
        .nav-tabs { display: flex; gap: 15px; overflow-x: auto; padding-bottom: 5px; }
        .tab-btn {
            background: var(--bg-light); border: 1px solid #dcdcdc; padding: 10px 20px; font-family: inherit; font-size: 0.85rem; font-weight: 600;
            color: #7f8c8d; cursor: pointer; border-radius: 50px; transition: all 0.3s; white-space: nowrap;
        }
        .tab-btn:hover { background: #eef7ff; color: var(--primary); }
        .tab-btn.active { background: var(--primary); color: var(--white); border-color: var(--primary); box-shadow: 0 4px 10px rgba(0,0,0,0.1); }

        /* PANEL DE FASE VERIFICAR */
        .phase-panel {
            display: flex; align-items: center; justify-content: space-between; width: 100%;
            background: #eef7ff; padding: 15px 25px; border-radius: 12px; border: 1px solid #b3d7ff;
        }
        .phase-title { color: var(--primary); font-weight: 700; font-size: 0.95rem; display: flex; align-items: center; gap: 10px; }

        /* CONTAINER */
        .container { max-width: 1300px; margin: 30px auto; padding: 0 30px; }

        /* KPI GRID */
        .kpi-grid { display: grid; grid-template-columns: repeat(3, 1fr); gap: 25px; margin-bottom: 30px; }
        .kpi-card { 
            background: var(--white); padding: 25px; border-radius: 12px; text-align: center; 
            box-shadow: 0 4px 20px rgba(0,0,0,0.04); border-top: 4px solid transparent;
        }
        .kpi-title { font-size: 0.75rem; text-transform: uppercase; letter-spacing: 1px; color: #95a5a6; font-weight: 700; }
        .kpi-value { font-size: 2.5rem; font-weight: 800; display: block; margin-top: 10px; color: var(--text-dark); }
        .kpi-sub { font-size: 0.8rem; color: #7f8c8d; margin-top: 5px; display: block; }

        /* CHARTS */
        .chart-card { background: var(--white); padding: 25px; border-radius: 12px; box-shadow: 0 4px 20px rgba(0,0,0,0.04); height: 450px; margin-bottom: 30px;}
        .section-header { margin-bottom: 20px; border-left: 4px solid var(--accent); padding-left: 12px; color: var(--primary); font-size: 1.1rem; font-weight: 700; }

        /* TABLE */
        .table-card { background: var(--white); padding: 25px; border-radius: 12px; box-shadow: 0 4px 20px rgba(0,0,0,0.04); overflow: hidden; }
        .table-responsive { overflow-x: auto; }
        table { width: 100%; border-collapse: collapse; font-size: 0.9rem; }
        th { background: #f8f9fa; color: var(--primary); padding: 15px; text-align: left; border-bottom: 2px solid #eee; font-weight: 700; text-transform: uppercase; font-size: 0.75rem; }
        td { padding: 15px; border-bottom: 1px solid #f0f0f0; vertical-align: middle; color: #4a5568; }
        
        /* INPUT DE VALIDACIÓN */
        .input-val {
            width: 70px; padding: 6px; border: 1px solid #ccc; border-radius: 4px; 
            text-align: center; font-weight: 700; color: var(--primary); background: #fafffb;
        }
        .input-val:focus { border-color: var(--primary); outline: none; background: #fff; }

        /* SEMÁFORO DE VALIDACIÓN */
        .semaforo-btn {
            width: 32px; height: 32px; border-radius: 50%; border: none; cursor: pointer;
            transition: all 0.2s; box-shadow: 0 3px 6px rgba(0,0,0,0.1);
            display: flex; align-items: center; justify-content: center; font-size: 0.9rem; color: white;
        }
        .semaforo-btn:hover { transform: scale(1.15); }
        
        .s-gris { background-color: #ecf0f1; border: 2px solid #bdc3c7; color: #bdc3c7; }
        .s-verde { background-color: #2ecc71; border: 2px solid #27ae60; box-shadow: 0 0 10px rgba(46, 204, 113, 0.4); }
        .s-amarillo { background-color: #f1c40f; border: 2px solid #f39c12; box-shadow: 0 0 10px rgba(241, 196, 15, 0.4); }
        .s-rojo { background-color: #e74c3c; border: 2px solid #c0392b; box-shadow: 0 0 10px rgba(231, 76, 60, 0.4); }

        /* TOOLTIP */
        .tooltip-container { position: relative; display: inline-block; cursor: pointer; }
        .tooltip-icon { color: var(--accent); font-size: 1rem; transition: transform 0.2s; }
        .tooltip-icon:hover { transform: scale(1.2); }
        .tooltip-content {
            visibility: hidden; width: 300px; background-color: #333; color: #fff; text-align: left;
            border-radius: 6px; padding: 10px; position: absolute; z-index: 1; bottom: 125%; left: 50%;
            margin-left: -150px; opacity: 0; transition: opacity 0.3s; font-size: 0.75rem; line-height: 1.4;
            box-shadow: 0 4px 15px rgba(0,0,0,0.2);
        }
        .tooltip-content::after {
            content: ""; position: absolute; top: 100%; left: 50%; margin-left: -5px;
            border-width: 5px; border-style: solid; border-color: #333 transparent transparent transparent;
        }
        .tooltip-container:hover .tooltip-content { visibility: visible; opacity: 1; }

        @media (max-width: 900px) { 
            .kpi-grid { grid-template-columns: 1fr; } 
            .header-top { flex-direction: column; text-align: center; gap: 15px; }
            .phase-panel { flex-direction: column; gap: 10px; text-align: center; }
        }
    </style>
</head>
<body>

    <header class="header-top">
        <div class="header-info">
            <h1>TABLERO DE VALIDACIÓN CERS</h1>
            <p class="subtitle">Análisis de Alineación y Brechas - Fase 6.2.1.3</p>
        </div>
        
        <div class="header-right">
            <div class="logos-container">
                <img src="logos/alcaldia.png" alt="Alcaldía">
                <img src="logos/unillanos.png" alt="Unillanos">
            </div>
        </div>
    </header>

    <div class="control-bar">
        <nav class="nav-tabs">
            <button class="tab-btn active" onclick="loadTab('NACIONAL')">1. Ref. Nacionales</button>
            <button class="tab-btn" onclick="loadTab('INTERNACIONAL')">2. Ref. Internacionales</button>
            <button class="tab-btn" onclick="loadTab('GENERAL')">3. Matriz General</button>
        </nav>

        <div class="phase-panel">
            <div class="phase-title">
                <i class="fas fa-check-double"></i>
                FASE VERIFICAR: VALIDACIÓN DE HALLAZGOS
            </div>
            <div style="font-size:0.85rem; font-weight:600; color:#555;">
                <span id="val-counter">0</span> de <span id="total-counter">0</span> líneas verificadas por comité.
            </div>
        </div>
    </div>

    <div class="container">
        
        <div id="loading" style="text-align:center; padding:80px; color:#bdc3c7;">
            <i class="fas fa-spinner fa-spin fa-3x" style="color:var(--primary);"></i>
            <p style="margin-top:15px; font-weight:600;">Cargando matriz comparativa...</p>
        </div>

        <div id="dashboard-content" style="display:none;">
            
            <div class="kpi-grid">
                <div class="kpi-card" style="border-top-color: var(--initial);">
                    <span class="kpi-title">Alineación Documental (Inicial)</span>
                    <span class="kpi-value" id="kpi-inicial" style="color:var(--initial);">0%</span>
                    <span class="kpi-sub">Hallazgo en Matriz</span>
                </div>
                <div class="kpi-card" style="border-top-color: var(--final);">
                    <span class="kpi-title">Alineación Verificada (Final)</span>
                    <span class="kpi-value" id="kpi-final" style="color:var(--final);">0%</span>
                    <span class="kpi-sub">Validado por Comité</span>
                </div>
                <div class="kpi-card" style="border-top-color: #e74c3c;">
                    <span class="kpi-title">Brecha Identificada</span>
                    <span class="kpi-value" id="kpi-delta" style="color:#e74c3c;">-0%</span>
                    <span class="kpi-sub">Diferencia vs Estándar</span>
                </div>
            </div>

            <div class="chart-card">
                <div class="section-header">Gráfico de Comparación: Datos Iniciales vs Finales</div>
                <div style="height: 380px; position: relative;">
                    <canvas id="chartComparativo"></canvas>
                </div>
            </div>

            <div class="table-card">
                <div class="section-header">Lista de Verificación y Ajuste</div>
                <div class="table-responsive">
                    <table id="tablaDetalle">
                        <thead>
                            <tr>
                                <th style="width: 35%;">Línea Estratégica / Criterio</th>
                                <th style="width: 12%; text-align:center;">Dato Inicial</th>
                                <th style="width: 12%; text-align:center;">Dato Final (Validado)</th>
                                <th style="width: 25%; text-align:center;">Evidencia / Observación</th>
                                <th style="width: 16%; text-align:center;">Estado Validación</th>
                            </tr>
                        </thead>
                        <tbody></tbody>
                    </table>
                </div>
            </div>
        </div>
    </div>

    <script>
        // CONFIGURACIÓN DE DATOS
        const SHEETS_CONFIG = {
            'GENERAL': {
                url: 'https://docs.google.com/spreadsheets/d/e/2PACX-1vR3D2ho2jJV0hYbNOzVweclC4SYDifw5AGMEV8HO318cgxpl9tz4nkocubdFCrxxOX7Z8DZ21Ex-1IG/pub?gid=1428307109&single=true&output=csv',
                colIndex: { name: 0, pct: 3, rec: 5 } 
            },
            'NACIONAL': {
                url: 'https://docs.google.com/spreadsheets/d/e/2PACX-1vR3D2ho2jJV0hYbNOzVweclC4SYDifw5AGMEV8HO318cgxpl9tz4nkocubdFCrxxOX7Z8DZ21Ex-1IG/pub?gid=607322215&single=true&output=csv',
                colIndex: { name: 0, pct: 4, rec: 6 }
            },
            'INTERNACIONAL': {
                url: 'https://docs.google.com/spreadsheets/d/e/2PACX-1vR3D2ho2jJV0hYbNOzVweclC4SYDifw5AGMEV8HO318cgxpl9tz4nkocubdFCrxxOX7Z8DZ21Ex-1IG/pub?gid=113039783&single=true&output=csv',
                colIndex: { name: 0, pct: 4, rec: 6 }
            }
        };

        let currentData = [];
        let chartComparativo = null;

        window.onload = function() { loadTab('NACIONAL'); };

        function loadTab(tabName) {
            document.querySelectorAll('.tab-btn').forEach(btn => btn.classList.remove('active'));
            const activeBtn = Array.from(document.querySelectorAll('.tab-btn')).find(b => b.onclick.toString().includes(`'${tabName}'`));
            if(activeBtn) activeBtn.classList.add('active');

            document.getElementById('loading').style.display = 'block';
            document.getElementById('dashboard-content').style.display = 'none';

            const config = SHEETS_CONFIG[tabName];
            Papa.parse(config.url, {
                download: true, header: false,
                complete: function(results) { processCSV(results.data, config.colIndex); },
                error: function() { alert('Error de conexión.'); }
            });
        }

        function processCSV(data, mapping) {
            const clean = [];
            for (let i = 2; i < data.length; i++) {
                const row = data[i];
                if (row[mapping.name] && row[mapping.name].trim() !== "" && !row[mapping.name].includes("Elaborado por")) {
                    let rawPct = row[mapping.pct];
                    if(typeof rawPct === 'string') rawPct = rawPct.replace('%', '').replace(',', '.');
                    let val = parseFloat(rawPct) || 0;
                    
                    // LÓGICA CORREGIDA: NO HAY SIMULACIÓN AUTOMÁTICA
                    // El valor final inicia siendo igual al inicial. 
                    // Solo cambia si el comité lo ajusta en la validación.
                    let valorFinal = val; 

                    clean.push({
                        id: i,
                        linea: row[mapping.name],
                        inicial: val,
                        final: valorFinal,
                        recomendacion: row[mapping.rec] || "Sin observación registrada.",
                        status: 0 // 0: gris, 1: verde, 2: amarillo, 3: rojo
                    });
                }
            }
            currentData = clean;
            document.getElementById('loading').style.display = 'none';
            document.getElementById('dashboard-content').style.display = 'block';
            renderDashboard();
        }

        function updateValue(index, newValue) {
            let val = parseFloat(newValue);
            if(isNaN(val)) val = 0;
            if(val > 100) val = 100;

            currentData[index].final = val;
            currentData[index].status = 2; // Pasa a estado "Ajustado"
            renderDashboard(false);
        }

        function cycleStatus(index) {
            currentData[index].status = (currentData[index].status + 1) % 4;
            renderDashboard(false);
        }

        function getStatusProps(status) {
            switch(status) {
                case 1: return { class: 's-verde', icon: '<i class="fas fa-check"></i>', text: 'Validado (Dato Final)' };
                case 2: return { class: 's-amarillo', icon: '<i class="fas fa-pen"></i>', text: 'Ajustado' };
                case 3: return { class: 's-rojo', icon: '<i class="fas fa-times"></i>', text: 'Rechazado' };
                default: return { class: 's-gris', icon: '<i class="fas fa-minus"></i>', text: 'Pendiente' };
            }
        }

        function updateKPIs() {
            const total = currentData.length;
            const avgInit = total ? currentData.reduce((a,b)=>a+b.inicial,0)/total : 0;
            const avgFinal = total ? currentData.reduce((a,b)=>a+b.final,0)/total : 0;
            
            // BRECHA: Distancia contra el 100% (Estándar)
            // O si prefieres, diferencia entre final e inicial. 
            // Para "identificar brechas" del objetivo, mostramos cuánto falta para el 100.
            const brecha = 100 - avgFinal;
            
            const validatedCount = currentData.filter(d => d.status === 1 || d.status === 2).length;

            document.getElementById('kpi-inicial').innerText = Math.round(avgInit) + '%';
            document.getElementById('kpi-final').innerText = Math.round(avgFinal) + '%';
            document.getElementById('kpi-delta').innerText = '-' + Math.round(brecha) + '%'; // Brecha restante
            
            document.getElementById('val-counter').innerText = validatedCount;
            document.getElementById('total-counter').innerText = total;
        }

        function renderDashboard(fullRender = true) {
            updateKPIs();
            updateChart(); 

            if(!fullRender) {
                // Actualizar solo botones para interactividad rápida
                currentData.forEach((item, index) => {
                    const props = getStatusProps(item.status);
                    const btn = document.getElementById(`btn-status-${index}`);
                    if(btn) {
                        btn.className = `semaforo-btn ${props.class}`;
                        btn.innerHTML = props.icon;
                        btn.title = props.text;
                    }
                });
                return; 
            }

            const tbody = document.querySelector('#tablaDetalle tbody');
            tbody.innerHTML = '';
            
            currentData.forEach((item, index) => {
                const props = getStatusProps(item.status);

                const tr = document.createElement('tr');
                tr.id = `row-${index}`;
                tr.innerHTML = `
                    <td><strong>${item.linea}</strong></td>
                    <td style="text-align:center; color:#7f8c8d; font-weight:600;">${item.inicial}%</td>
                    <td style="text-align:center;">
                        <input type="number" class="input-val" value="${item.final}" 
                        onchange="updateValue(${index}, this.value)" min="0" max="100">
                    </td>
                    <td style="text-align:center;">
                        <div class="tooltip-container">
                            <i class="fas fa-file-alt tooltip-icon"></i>
                            <span class="tooltip-content">
                                <strong>Evidencia Documental:</strong><br>
                                ${item.recomendacion}
                            </span>
                        </div>
                    </td>
                    <td style="text-align:center;">
                        <div style="display:flex; justify-content:center;">
                            <button id="btn-status-${index}" class="semaforo-btn ${props.class}" onclick="cycleStatus(${index})" title="${props.text}">
                                ${props.icon}
                            </button>
                        </div>
                    </td>
                `;
                tbody.appendChild(tr);
            });
        }

        function updateChart() {
            const ctx = document.getElementById('chartComparativo').getContext('2d');
            if (chartComparativo) chartComparativo.destroy();

            const labels = currentData.map(d => d.linea.length > 35 ? d.linea.substring(0,35)+'...' : d.linea);
            
            chartComparativo = new Chart(ctx, {
                type: 'bar',
                data: {
                    labels: labels,
                    datasets: [
                        {
                            label: 'Datos Iniciales (Documental)',
                            data: currentData.map(d => d.inicial),
                            backgroundColor: '#bdc3c7',
                            borderRadius: 4
                        },
                        {
                            label: 'Datos Finales (Verificados)',
                            data: currentData.map(d => d.final),
                            backgroundColor: '#003366',
                            borderRadius: 4
                        }
                    ]
                },
                options: { 
                    indexAxis: 'y', 
                    responsive: true, maintainAspectRatio: false, 
                    scales: { x: { max: 100, grid: {color:'#f0f0f0'} }, y: { grid:{display:false} } }, 
                    plugins: { 
                        legend: { position: 'top', align: 'end' },
                        tooltip: {
                            callbacks: {
                                afterBody: function(context) {
                                    const index = context[0].dataIndex;
                                    return '\nObs: ' + currentData[index].recomendacion.substring(0, 50) + '...';
                                }
                            }
                        }
                    } 
                }
            });
        }
    </script>
</body>
</html>
