<!doctype html>
<html lang="es">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width,initial-scale=1" />
  <title>Dashboard CERS – Villavicencio</title>

  <!-- Bootstrap (estilos rápidos) -->
  <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.2/dist/css/bootstrap.min.css" rel="stylesheet">

  <!-- PapaParse para CSV -->
  <script src="https://cdn.jsdelivr.net/npm/papaparse@5.4.1/papaparse.min.js"></script>
  <!-- Chart.js para gráficas -->
  <script src="https://cdn.jsdelivr.net/npm/chart.js@4.4.0/dist/chart.umd.min.js"></script>

  <style>
    body { font-family: Inter, system-ui, -apple-system, "Segoe UI", Roboto, "Helvetica Neue", Arial; padding: 1.25rem; background: #f7f9fc; }
    .card { box-shadow: 0 6px 18px rgba(26, 43, 64, 0.06); border: none; }
    .small-muted { font-size: .85rem; color: #6b7280; }
    .table-wrap { max-height: 420px; overflow:auto; }
    nav .nav-link { cursor:pointer; }
    .control-row > * { margin-right: .5rem; }
    footer { margin-top: 1.5rem; color: #6b7280; font-size: .85rem; }
  </style>
</head>
<body>
  <div class="container-fluid">
    <header class="d-flex align-items-center mb-3">
      <div>
        <h2 class="mb-0">Dashboard: CERS – Villavicencio</h2>
        <div class="small-muted">Datos enlazados en vivo desde Google Sheets (CSV)</div>
      </div>
      <div class="ms-auto small-muted">Actualizado en vivo · Sin backend</div>
    </header>

    <!-- Nav tabs -->
    <ul class="nav nav-tabs mb-3" id="tabs">
      <li class="nav-item"><a class="nav-link active" data-target="nacional">NACIONAL</a></li>
      <li class="nav-item"><a class="nav-link" data-target="internacional">INTERNACIONAL</a></li>
      <li class="nav-item"><a class="nav-link" data-target="general">GENERAL</a></li>
    </ul>

    <!-- Content area -->
    <div id="content-area">
      <!-- Template for each tab -->
      <template id="tab-template">
        <div class="tab-pane">
          <div class="row mb-3">
            <div class="col-md-4">
              <div class="card p-3">
                <h6 class="mb-2">Resumen</h6>
                <div id="summary" class="small-muted">Cargando...</div>
                <div class="mt-3">
                  <div class="control-row d-flex align-items-center">
                    <label class="me-2 small-muted">Columna numérica:</label>
                    <select id="numeric-select" class="form-select form-select-sm"></select>
                  </div>
                  <div class="control-row d-flex align-items-center mt-2">
                    <label class="me-2 small-muted">Columna de categoría:</label>
                    <select id="category-select" class="form-select form-select-sm"></select>
                  </div>
                </div>
              </div>
            </div>

            <div class="col-md-8">
              <div class="card p-3 mb-2">
                <h6 class="mb-2">Gráfica 1 — Series</h6>
                <canvas id="chart-line" height="110"></canvas>
              </div>
              <div class="card p-3">
                <h6 class="mb-2">Gráfica 2 — Top categorías</h6>
                <canvas id="chart-bar" height="110"></canvas>
              </div>
            </div>
          </div>

          <div class="card p-3">
            <div class="d-flex mb-2">
              <div class="me-auto">
                <input id="table-search" class="form-control form-control-sm" placeholder="Buscar en tabla..." />
              </div>
              <div class="ms-2">
                <button id="download-csv" class="btn btn-outline-secondary btn-sm">Descargar CSV</button>
              </div>
            </div>
            <div class="table-wrap">
              <table id="data-table" class="table table-sm table-striped">
                <thead id="table-head"></thead>
                <tbody id="table-body"></tbody>
              </table>
            </div>
          </div>
        </div>
      </template>
    </div>

    <footer class="text-center">
      Hecho con ❤️ · Copia este archivo en GitHub Pages para que corra en vivo.
    </footer>
  </div>

<script>
/* ---------- CONFIG: pega aquí tus CSV publicados ---------- */
const sources = {
  nacional: "https://docs.google.com/spreadsheets/d/e/2PACX-1vR3D2ho2jJV0hYbNOzVweclC4SYDifw5AGMEV8HO318cgxpl9tz4nkocubdFCrxxOX7Z8DZ21Ex-1IG/pub?gid=563980265&single=true&output=csv",
  internacional: "https://docs.google.com/spreadsheets/d/e/2PACX-1vR3D2ho2jJV0hYbNOzVweclC4SYDifw5AGMEV8HO318cgxpl9tz4nkocubdFCrxxOX7Z8DZ21Ex-1IG/pub?gid=804794750&single=true&output=csv",
  general: "https://docs.google.com/spreadsheets/d/e/2PACX-1vR3D2ho2jJV0hYbNOzVweclC4SYDifw5AGMEV8HO318cgxpl9tz4nkocubdFCrxxOX7Z8DZ21Ex-1IG/pub?gid=24842196&single=true&output=csv"
};
/* --------------------------------------------------------- */

const tabsContainer = document.getElementById('tabs');
const contentArea = document.getElementById('content-area');
const template = document.getElementById('tab-template').content;
let current = 'nacional';
const state = {}; // guarda datos por pestaña
let charts = {}; // guardará instancias Chart.js

// Inicializar pestañas
function initTabs(){
  document.querySelectorAll('#tabs .nav-link').forEach(a=>{
    a.addEventListener('click', ()=> {
      document.querySelectorAll('#tabs .nav-link').forEach(x=>x.classList.remove('active'));
      a.classList.add('active');
      const target = a.getAttribute('data-target');
      showTab(target);
    });
  });
  showTab(current);
}

function showTab(name){
  current = name;
  // limpiar content
  contentArea.innerHTML = '';
  const clone = template.cloneNode(true);
  contentArea.appendChild(clone);
  const pane = contentArea.querySelector('.tab-pane');

  // asignar elementos locales
  const summaryEl = pane.querySelector('#summary');
  const numSelect = pane.querySelector('#numeric-select');
  const catSelect = pane.querySelector('#category-select');
  const chartLineCtx = pane.querySelector('#chart-line').getContext('2d');
  const chartBarCtx = pane.querySelector('#chart-bar').getContext('2d');
  const tableHead = pane.querySelector('#table-head');
  const tableBody = pane.querySelector('#table-body');
  const searchInput = pane.querySelector('#table-search');
  const downloadBtn = pane.querySelector('#download-csv');

  // si ya cargamos antes esta pestaña, usamos cache
  if(state[name] && state[name].loaded){
    renderFromState(name, {summaryEl, numSelect, catSelect, chartLineCtx, chartBarCtx, tableHead, tableBody, searchInput, downloadBtn});
    return;
  }

  summaryEl.textContent = 'Cargando datos...';

  Papa.parse(sources[name], {
    download: true,
    header: true,
    skipEmptyLines: true,
    complete: function(results){
      const data = results.data;
      const fields = results.meta.fields || [];
      state[name] = { data, fields, loaded: true, sourceUrl: sources[name] };
      renderFromState(name, {summaryEl, numSelect, catSelect, chartLineCtx, chartBarCtx, tableHead, tableBody, searchInput, downloadBtn});
    },
    error: function(err){
      summaryEl.textContent = 'Error cargando CSV: ' + err.message;
    }
  });
}

// renderiza usando state[name]
function renderFromState(name, els){
  const { data, fields } = state[name];
  const { summaryEl, numSelect, catSelect, chartLineCtx, chartBarCtx, tableHead, tableBody, searchInput, downloadBtn } = els;

  // Resumen
  summaryEl.innerHTML = `
    Filas: <strong>${data.length.toLocaleString()}</strong><br>
    Columnas: <strong>${fields.length}</strong><br>
    Fuente: <small class="text-break">${state[name].sourceUrl}</small>
  `;

  // Detectar columnas numéricas (simple)
  const numericCols = detectNumericColumns(data, fields);
  const textualCols = fields.filter(f => !numericCols.includes(f));

  // llenar selects
  numSelect.innerHTML = numericCols.length ? numericCols.map(c=>`<option value="${c}">${c}</option>`).join('') : '<option disabled>Sin columnas numéricas</option>';
  catSelect.innerHTML = textualCols.length ? textualCols.map(c=>`<option value="${c}">${c}</option>`).join('') : '<option disabled>Sin columnas de categoría</option>';

  // crear gráficos iniciales
  const chosenNum = numericCols[0] || null;
  const chosenCat = textualCols[0] || null;

  // listeners para cambiar columna graficada
  numSelect.addEventListener('change', ()=> updateCharts());
  catSelect.addEventListener('change', ()=> updateCharts());

  // poblar tabla (simple)
  buildTable(fields, data, tableHead, tableBody);

  // busqueda en tabla
  searchInput.addEventListener('input', (e)=> filterTable(e.target.value, fields, data, tableHead, tableBody));

  // descarga CSV (reutiliza origen)
  downloadBtn.addEventListener('click', ()=>{
    const blob = new Blob([Papa.unparse(data)], {type: 'text/csv;charset=utf-8;'});
    const link = document.createElement('a');
    link.href = URL.createObjectURL(blob);
    link.download = `${name}_export.csv`;
    link.click();
  });

  // crear charts Chart.js
  if(charts[name]) { charts[name].line.destroy(); charts[name].bar.destroy(); }
  charts[name] = { line: null, bar: null };

  function updateCharts(){
    const numCol = numSelect.value || chosenNum;
    const catCol = catSelect.value || chosenCat;
    // Line: si existe columna "Fecha" o index, tratar de usarla para labels; si no, usar indices
    let labels = data.map((r,i)=> r['Fecha'] || r['fecha'] || r['Date'] || (i+1));
    let values = data.map(r => parseFloat(cleanNumber(r[numCol])) ).map(v=> isFinite(v)? v : 0);

    // Top categories (sum numeric by category)
    let groups = {};
    data.forEach(r=>{
      const key = r[catCol] || '—';
      const val = parseFloat(cleanNumber(r[numCol])) || 0;
      groups[key] = (groups[key] || 0) + val;
    });
    // take top 8 categories
    const pairs = Object.entries(groups).sort((a,b)=> b[1]-a[1]).slice(0,8);
    const gLabels = pairs.map(p=>p[0]);
    const gValues = pairs.map(p=>p[1]);

    // Line chart
    if(charts[name].line) charts[name].line.destroy();
    charts[name].line = new Chart(chartLineCtx, {
      type: 'line',
      data: { labels, datasets: [{ label: numCol || 'Valor', data: values, tension: .3, fill: true }] },
      options: { responsive:true, plugins:{legend:{display:false}} }
    });

    // Bar chart
    if(charts[name].bar) charts[name].bar.destroy();
    charts[name].bar = new Chart(chartBarCtx, {
      type: 'bar',
      data: { labels: gLabels, datasets: [{ label: 'Suma por categoría', data: gValues }] },
      options: { responsive:true, plugins:{legend:{display:false}}, scales:{x:{ticks:{autoSkip:true}}} }
    });
  }

  // primera renderización
  updateCharts();
}

// util: detectar columnas numéricas
function detectNumericColumns(data, fields){
  const numeric = [];
  fields.forEach(f=>{
    let countNumeric = 0, checked = 0;
    for(let i=0;i<Math.min(50,data.length);i++){
      const v = data[i][f];
      if(v===undefined || v===null || String(v).trim()==='') { checked++; continue; }
      checked++;
      const n = parseFloat(cleanNumber(v));
      if(!isNaN(n)) countNumeric++;
    }
    // si más de la mitad de los valores comprobados son numéricos -> lo consideramos numérico
    if(checked>0 && (countNumeric / checked) >= 0.6) numeric.push(f);
  });
  return numeric;
}

// limpia formatos comunes de números (coma, signo, etc.)
function cleanNumber(v){
  if(v===null || v===undefined) return '';
  return String(v).replace(/\$/g,'').replace(/,/g,'').replace(/\s+/g,'').replace(/%/g,'').replace(/—/g,'').trim();
}

// construir tabla HTML
function buildTable(fields, data, theadEl, tbodyEl){
  theadEl.innerHTML = '<tr>' + fields.map(f=>`<th>${f}</th>`).join('') + '</tr>';
  tbodyEl.innerHTML = data.map(row => {
    return '<tr>' + fields.map(f => `<td>${escapeHtml(row[f] ?? '')}</td>`).join('') + '</tr>';
  }).join('');
}

// Buscar y filtrar tabla
function filterTable(q, fields, data, theadEl, tbodyEl){
  const ql = q.toLowerCase();
  const filtered = data.filter(r=>{
    return fields.some(f=>{
      return String(r[f] ?? '').toLowerCase().includes(ql);
    });
  });
  tbodyEl.innerHTML = filtered.map(row => {
    return '<tr>' + fields.map(f => `<td>${escapeHtml(row[f] ?? '')}</td>`).join('') + '</tr>';
  }).join('');
}

// escape
function escapeHtml(s){ return String(s).replace(/&/g,'&amp;').replace(/</g,'&lt;').replace(/>/g,'&gt;'); }

// init
initTabs();

</script>
</body>
</html>
